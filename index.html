<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>JalRakshak â€” National Drought Management Portal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Noto+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Noto+Sans+Devanagari:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
<style>
:root {
  --navy: #0D2137;
  --navy2: #1A3454;
  --saffron: #FF6B00;
  --saffron2: #FF8C38;
  --gold: #D4AC0D;
  --gold2: #F0C93A;
  --green: #138808;
  --green2: #1BA00A;
  --cream: #FEF9F0;
  --sand: #F5ECD7;
  --border: #D6C5A0;
  --text: #1A2744;
  --muted: #6B7A99;
  --white: #FFFFFF;
  --red: #C62828;
  --orange: #E65100;
  --yellow: #F9A825;
  --blue: #0277BD;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Noto Sans', sans-serif;
  background: var(--cream);
  color: var(--text);
  min-height: 100vh;
}

/* â•â•â• GOV HEADER â•â•â• */
.gov-header {
  background: var(--navy);
  color: white;
  padding: 0;
  border-bottom: 4px solid var(--saffron);
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 2px 12px rgba(0,0,0,0.35);
}

.gov-header-top {
  background: linear-gradient(90deg, #0a1a2f, #1a3454, #0a1a2f);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem 1.5rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  font-size: 0.72rem;
  color: rgba(255,255,255,0.7);
  letter-spacing: 0.05em;
}

.gov-header-main {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.75rem 1.5rem;
  gap: 1rem;
}

.gov-logo-area {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.emblem {
  width: 52px;
  height: 52px;
  background: radial-gradient(circle, #D4AC0D, #8B6914);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  border: 2px solid var(--gold);
}

.gov-title-block { color: white; }
.gov-title-block .main-title {
  font-family: 'Rajdhani', sans-serif;
  font-size: 1.4rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  color: var(--gold2);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.gov-title-block .sub-title {
  font-size: 0.7rem;
  color: rgba(255,255,255,0.65);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-top: 1px;
}

.gov-title-block .ministry {
  font-size: 0.8rem;
  color: rgba(255,255,255,0.85);
  margin-top: 2px;
}

.tricolor-bar {
  display: flex;
  gap: 2px;
}

.tricolor-bar div {
  width: 6px;
  height: 32px;
  border-radius: 3px;
}

/* â•â•â• LANGUAGE SELECTOR â•â•â• */
.lang-select {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.25);
  color: white;
  padding: 0.35rem 0.7rem;
  border-radius: 6px;
  font-size: 0.82rem;
  cursor: pointer;
  font-family: 'Noto Sans', sans-serif;
}

.lang-select option {
  background: #1a3454;
  color: white;
}

/* â•â•â• LOGIN PAGE â•â•â• */
.login-page {
  min-height: calc(100vh - 90px);
  background: linear-gradient(135deg, #0D2137 0%, #1A3454 40%, #0D3B5E 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  position: relative;
  overflow: hidden;
}

.login-bg-pattern {
  position: absolute;
  inset: 0;
  background-image: 
    radial-gradient(circle at 20% 50%, rgba(255,107,0,0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(19,136,8,0.08) 0%, transparent 40%),
    radial-gradient(circle at 60% 80%, rgba(212,172,13,0.06) 0%, transparent 40%);
}

.login-watermark {
  position: absolute;
  font-size: 18rem;
  color: rgba(255,255,255,0.02);
  font-weight: 900;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  pointer-events: none;
  user-select: none;
}

.login-card {
  background: rgba(255,255,255,0.97);
  border-radius: 16px;
  padding: 2.5rem;
  width: 100%;
  max-width: 520px;
  box-shadow: 0 24px 80px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1);
  position: relative;
  z-index: 1;
  border-top: 5px solid var(--saffron);
}

.login-badge {
  background: linear-gradient(135deg, #0D2137, #1A3454);
  color: white;
  border-radius: 50px;
  padding: 0.4rem 1.2rem;
  font-size: 0.72rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  margin-bottom: 1.5rem;
}

.login-heading {
  font-family: 'Rajdhani', sans-serif;
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 0.3rem;
}

.login-subtitle {
  font-size: 0.83rem;
  color: var(--muted);
  margin-bottom: 2rem;
  line-height: 1.5;
}

.role-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.8rem;
  margin-bottom: 1.5rem;
}

.role-card {
  border: 2px solid var(--border);
  border-radius: 10px;
  padding: 1rem 0.7rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: white;
}

.role-card:hover {
  border-color: var(--saffron);
  background: #FFF5EC;
}

.role-card.active {
  border-color: var(--saffron);
  background: linear-gradient(135deg, #FFF5EC, #FFF0E0);
  box-shadow: 0 0 0 3px rgba(255,107,0,0.15);
}

.role-icon { font-size: 2rem; margin-bottom: 0.5rem; }
.role-name { font-size: 0.72rem; font-weight: 700; color: var(--navy); line-height: 1.3; text-transform: uppercase; letter-spacing: 0.04em; }

.form-group { margin-bottom: 1rem; }
.form-label {
  display: block;
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--navy);
  margin-bottom: 0.4rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.form-control {
  width: 100%;
  padding: 0.65rem 0.9rem;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  font-size: 0.9rem;
  font-family: 'Noto Sans', sans-serif;
  color: var(--text);
  background: white;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.form-control:focus {
  border-color: var(--saffron);
  box-shadow: 0 0 0 3px rgba(255,107,0,0.12);
}

.otp-row {
  display: flex;
  gap: 0.5rem;
}

.otp-input {
  flex: 1;
  letter-spacing: 0.3em;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 1.3rem;
  text-align: center;
  padding: 0.6rem;
}

.btn-primary {
  background: linear-gradient(135deg, var(--saffron), #E85D00);
  color: white;
  border: none;
  padding: 0.8rem 1.5rem;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  width: 100%;
  font-family: 'Noto Sans', sans-serif;
  letter-spacing: 0.03em;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  box-shadow: 0 4px 15px rgba(255,107,0,0.35);
}

.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(255,107,0,0.45);
}

.btn-secondary {
  background: white;
  color: var(--navy);
  border: 1.5px solid var(--border);
  padding: 0.65rem 1.2rem;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  font-family: 'Noto Sans', sans-serif;
  transition: all 0.2s;
}

.btn-secondary:hover {
  border-color: var(--navy);
  background: #f5f7fa;
}

.divider { height: 1px; background: var(--border); margin: 1.5rem 0; }

.otp-display {
  background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
  border: 2px solid var(--green);
  border-radius: 10px;
  padding: 1rem;
  text-align: center;
  margin: 0.8rem 0;
}

.otp-code-display {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--green);
  letter-spacing: 0.4em;
}

/* â•â•â• MAIN DASHBOARD LAYOUT â•â•â• */
.dashboard-layout {
  display: grid;
  grid-template-columns: 260px 1fr;
  min-height: calc(100vh - 90px);
}

/* â•â•â• SIDEBAR â•â•â• */
.sidebar {
  background: linear-gradient(180deg, #0D2137 0%, #1A3454 100%);
  color: white;
  padding: 0;
  display: flex;
  flex-direction: column;
  border-right: 3px solid var(--saffron);
  position: sticky;
  top: 90px;
  height: calc(100vh - 90px);
  overflow-y: auto;
}

.sidebar-user {
  padding: 1.5rem 1.2rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  background: rgba(0,0,0,0.2);
}

.user-avatar {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  margin-bottom: 0.8rem;
  border: 2px solid var(--saffron);
}

.user-name {
  font-family: 'Rajdhani', sans-serif;
  font-size: 1rem;
  font-weight: 700;
  color: var(--gold2);
}

.user-role {
  font-size: 0.72rem;
  color: rgba(255,255,255,0.6);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-top: 2px;
}

.user-location {
  font-size: 0.78rem;
  color: rgba(255,255,255,0.8);
  margin-top: 4px;
  display: flex;
  align-items: center;
  gap: 0.3rem;
}

.sidebar-stats {
  padding: 1rem 1.2rem;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}

.stat-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.35rem 0;
  font-size: 0.8rem;
  color: rgba(255,255,255,0.7);
}

.stat-val {
  font-family: 'IBM Plex Mono', monospace;
  font-weight: 600;
  color: var(--gold2);
}

.stat-val.red { color: #FF6B6B; }
.stat-val.green { color: #69DB7C; }
.stat-val.orange { color: var(--saffron2); }

.sidebar-nav {
  padding: 0.8rem 0;
  flex: 1;
}

.nav-section-label {
  padding: 0.5rem 1.2rem;
  font-size: 0.65rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: rgba(255,255,255,0.35);
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  padding: 0.7rem 1.2rem;
  cursor: pointer;
  transition: all 0.15s;
  font-size: 0.85rem;
  color: rgba(255,255,255,0.75);
  border-left: 3px solid transparent;
}

.nav-item:hover {
  background: rgba(255,255,255,0.07);
  color: white;
  border-left-color: rgba(255,107,0,0.5);
}

.nav-item.active {
  background: rgba(255,107,0,0.15);
  color: white;
  border-left-color: var(--saffron);
  font-weight: 600;
}

.nav-icon { font-size: 1.1rem; width: 20px; text-align: center; }

.sidebar-bottom {
  padding: 1rem 1.2rem;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.btn-logout {
  width: 100%;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.2);
  color: rgba(255,255,255,0.8);
  padding: 0.6rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.82rem;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.4rem;
}

.btn-logout:hover {
  background: rgba(255,100,100,0.2);
  border-color: rgba(255,100,100,0.4);
  color: #FF9999;
}

/* â•â•â• MAIN CONTENT â•â•â• */
.main-content {
  padding: 1.5rem;
  overflow-y: auto;
  background: var(--cream);
}

/* â•â•â• PAGE HEADER â•â•â• */
.page-header {
  background: linear-gradient(135deg, var(--navy), var(--navy2));
  color: white;
  border-radius: 12px;
  padding: 1.4rem 1.8rem;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-left: 6px solid var(--saffron);
  box-shadow: 0 4px 20px rgba(13,33,55,0.25);
}

.page-header-title {
  font-family: 'Rajdhani', sans-serif;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--gold2);
}

.page-header-sub {
  font-size: 0.8rem;
  color: rgba(255,255,255,0.7);
  margin-top: 3px;
}

/* â•â•â• METRIC CARDS â•â•â• */
.metrics-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.metric-card {
  background: white;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 1.2rem 1rem;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  border-top: 3px solid var(--saffron);
}

.metric-icon { font-size: 1.8rem; margin-bottom: 0.4rem; }
.metric-val { font-family: 'Rajdhani', sans-serif; font-size: 2rem; font-weight: 700; color: var(--navy); line-height: 1.1; }
.metric-label { font-size: 0.72rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.3rem; }
.metric-card.critical .metric-val { color: var(--red); }
.metric-card.warning .metric-val { color: var(--orange); }
.metric-card.ok .metric-val { color: var(--green); }

/* â•â•â• CARDS â•â•â• */
.card {
  background: white;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 1.4rem;
  margin-bottom: 1.2rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.card-title {
  font-family: 'Rajdhani', sans-serif;
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--navy);
  padding-bottom: 0.7rem;
  border-bottom: 2px solid var(--sand);
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.card-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem; margin-bottom: 1.2rem; }
.card-3col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.2rem; margin-bottom: 1.2rem; }

/* â•â•â• MAP â•â•â• */
#district-map, #village-map, #officer-map {
  height: 420px;
  border-radius: 10px;
  overflow: hidden;
  border: 1.5px solid var(--border);
}

/* â•â•â• VILLAGE TABLE â•â•â• */
.village-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
.village-table th {
  background: var(--navy);
  color: white;
  padding: 0.6rem 0.8rem;
  text-align: left;
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-weight: 600;
}

.village-table td {
  padding: 0.65rem 0.8rem;
  border-bottom: 1px solid var(--sand);
  color: var(--text);
}

.village-table tr:hover td { background: #FFF8F0; }
.village-table tr:nth-child(even) td { background: #FAFAFA; }
.village-table tr:nth-child(even):hover td { background: #FFF8F0; }

/* â•â•â• BADGES â•â•â• */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.2rem 0.6rem;
  border-radius: 20px;
  font-size: 0.72rem;
  font-weight: 700;
  border: 1px solid currentColor;
}

.badge-critical { background: #FFEBEE; color: #C62828; }
.badge-warning { background: #FFF3E0; color: #E65100; }
.badge-watch { background: #FFFDE7; color: #F9A825; }
.badge-normal { background: #E8F5E9; color: #2E7D32; }

/* â•â•â• ALERTS â•â•â• */
.alert {
  border-radius: 10px;
  padding: 0.9rem 1.2rem;
  margin-bottom: 1rem;
  font-size: 0.88rem;
  border-left: 5px solid;
  display: flex;
  gap: 0.7rem;
  align-items: flex-start;
}

.alert-critical { background: #FFEBEE; border-color: #C62828; color: #C62828; }
.alert-warning { background: #FFF3E0; border-color: #E65100; color: #BF360C; }
.alert-info { background: #E3F2FD; border-color: #0277BD; color: #01579B; }
.alert-success { background: #E8F5E9; border-color: #2E7D32; color: #1B5E20; }

/* â•â•â• WSI GAUGE BAR â•â•â• */
.wsi-gauge-bar {
  height: 14px;
  background: linear-gradient(90deg, #2E7D32 0%, #F9A825 33%, #E65100 66%, #C62828 100%);
  border-radius: 7px;
  position: relative;
  margin: 0.5rem 0;
}

.wsi-gauge-needle {
  position: absolute;
  top: -6px;
  width: 3px;
  height: 26px;
  background: var(--navy);
  border-radius: 2px;
  transform: translateX(-50%);
}

/* â•â•â• FLEET CARD â•â•â• */
.fleet-card {
  background: white;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  padding: 1rem 1.2rem;
  margin-bottom: 0.8rem;
  border-left: 5px solid var(--saffron);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* â•â•â• PROGRESS BAR â•â•â• */
.progress-bar { background: var(--sand); border-radius: 10px; height: 8px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 10px; transition: width 0.5s; }

/* â•â•â• TIMELINE â•â•â• */
.timeline-item { display: flex; gap: 0.8rem; margin-bottom: 0.8rem; }
.timeline-dot {
  width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; margin-top: 4px;
  border: 2px solid white; box-shadow: 0 0 0 2px currentColor;
}

/* â•â•â• NOTIFICATIONS â•â•â• */
.notif-item {
  display: flex;
  gap: 0.8rem;
  align-items: flex-start;
  padding: 0.8rem;
  border-radius: 8px;
  border: 1px solid var(--border);
  margin-bottom: 0.6rem;
  background: white;
}

/* â•â•â• FORM â•â•â• */
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
textarea.form-control { resize: vertical; min-height: 80px; }

/* â•â•â• WSI NUMBER DISPLAY â•â•â• */
.wsi-big {
  text-align: center;
  padding: 1.5rem;
  border-radius: 12px;
  border: 3px solid currentColor;
}
.wsi-num { font-family: 'Rajdhani', sans-serif; font-size: 4rem; font-weight: 700; line-height: 1; }
.wsi-label { font-size: 0.9rem; font-weight: 600; margin-top: 0.5rem; }

/* â•â•â• TABS â•â•â• */
.tab-bar {
  display: flex;
  gap: 0.3rem;
  background: var(--sand);
  padding: 0.4rem;
  border-radius: 10px;
  margin-bottom: 1.5rem;
}

.tab-btn {
  flex: 1;
  padding: 0.6rem 0.8rem;
  border: none;
  background: transparent;
  border-radius: 7px;
  cursor: pointer;
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--muted);
  font-family: 'Noto Sans', sans-serif;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.3rem;
}

.tab-btn:hover { background: rgba(255,255,255,0.6); color: var(--navy); }

.tab-btn.active {
  background: var(--navy);
  color: white;
  box-shadow: 0 2px 8px rgba(13,33,55,0.25);
}

/* â•â•â• MINI CHART BARS â•â•â• */
.mini-bars { display: flex; gap: 3px; align-items: flex-end; height: 50px; }
.mini-bar { flex: 1; border-radius: 3px 3px 0 0; min-width: 8px; }

/* â•â•â• ANIMATIONS â•â•â• */
@keyframes pulse-red {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}
.pulse { animation: pulse-red 1.5s infinite; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.fade-in { animation: fadeIn 0.3s ease; }

/* â•â•â• FOOTER â•â•â• */
.gov-footer {
  background: var(--navy);
  color: rgba(255,255,255,0.5);
  text-align: center;
  padding: 0.8rem;
  font-size: 0.72rem;
  border-top: 3px solid var(--saffron);
}

/* â•â•â• RESPONSIVE â•â•â• */
@media (max-width: 768px) {
  .dashboard-layout { grid-template-columns: 1fr; }
  .metrics-row { grid-template-columns: 1fr 1fr; }
  .role-grid { grid-template-columns: 1fr; }
}

/* â•â•â• SCROLLBAR â•â•â• */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--sand); }
::-webkit-scrollbar-thumb { background: var(--navy2); border-radius: 3px; }

/* â•â•â• TANKER STATUS COLORS â•â•â• */
.status-transit { border-left-color: var(--saffron) !important; }
.status-delivered { border-left-color: var(--green) !important; }
.status-available { border-left-color: var(--blue) !important; }
.status-maintenance { border-left-color: var(--red) !important; }
.status-scheduled { border-left-color: var(--muted) !important; }

.hidden { display: none; }

/* Policy decision alert boxes */
.policy-alert {
  background: linear-gradient(135deg, #1A3454, #0D2137);
  color: white;
  border-radius: 10px;
  padding: 1rem 1.2rem;
  margin-bottom: 0.7rem;
  border-left: 4px solid var(--saffron);
  font-size: 0.85rem;
}

.policy-alert .alert-title { font-weight: 700; color: var(--gold2); margin-bottom: 0.3rem; }
</style>
</head>
<body>

<!-- â•â•â• GOVERNMENT HEADER â•â•â• -->
<header class="gov-header">
  <div class="gov-header-top">
    <span>ğŸ‡®ğŸ‡³ Government of India â€” Ministry of Jal Shakti â€” National Water Mission</span>
    <div style="display:flex;align-items:center;gap:1rem;">
      <select class="lang-select" id="langSelect" onchange="changeLang(this.value)">
        <option value="en">ğŸŒ English</option>
        <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
        <option value="mr">à¤®à¤°à¤¾à¤ à¥€</option>
        <option value="te">à°¤à±†à°²à±à°—à±</option>
        <option value="ta">à®¤à®®à®¿à®´à¯</option>
        <option value="kn">à²•à²¨à³à²¨à²¡</option>
        <option value="gu">àª—à«àªœàª°àª¾àª¤à«€</option>
        <option value="bn">à¦¬à¦¾à¦‚à¦²à¦¾</option>
        <option value="ml">à´®à´²à´¯à´¾à´³à´‚</option>
        <option value="or">à¬“à¬¡à¬¼à¬¿à¬†</option>
        <option value="pa">à¨ªà©°à¨œà¨¾à¨¬à©€</option>
        <option value="ur">Ø§Ø±Ø¯Ùˆ</option>
        <option value="as">à¦…à¦¸à¦®à§€à¦¯à¦¼à¦¾</option>
        <option value="mai">à¤®à¥ˆà¤¥à¤¿à¤²à¥€</option>
        <option value="bho">à¤­à¥‹à¤œà¤ªà¥à¤°à¥€</option>
        <option value="raj">à¤°à¤¾à¤œà¤¸à¥à¤¥à¤¾à¤¨à¥€</option>
        <option value="kok">à¤•à¥‹à¤‚à¤•à¤£à¥€</option>
        <option value="mni">à¦®à§ˆà¦¤à§ˆà¦²à§‹à¦¨à§</option>
        <option value="sd">Ø³Ù†ÚŒÙŠ</option>
        <option value="ne">à¤¨à¥‡à¤ªà¤¾à¤²à¥€</option>
        <option value="sa">à¤¸à¤‚à¤¸à¥à¤•à¥ƒà¤¤à¤®à¥</option>
        <option value="sat">á±¥á±Ÿá±±á±›á±Ÿá±²á±¤</option>
      </select>
      <span id="current-time" style="font-family:monospace;font-size:0.8rem;"></span>
    </div>
  </div>
  <div class="gov-header-main">
    <div class="gov-logo-area">
      <div class="emblem">ğŸ’§</div>
      <div class="gov-title-block">
        <div class="main-title">JalRakshak</div>
        <div class="ministry" id="txt-ministry">Ministry of Jal Shakti, Government of India</div>
        <div class="sub-title" id="txt-portal">National Drought Management & Water Tanker Allocation Portal</div>
      </div>
    </div>
    <div class="tricolor-bar">
      <div style="background:#FF6B00;"></div>
      <div style="background:#FFFFFF;"></div>
      <div style="background:#138808;"></div>
    </div>
  </div>
</header>

<!-- â•â•â• LOGIN PAGE â•â•â• -->
<div id="login-page" class="login-page">
  <div class="login-watermark">ğŸ’§</div>
  <div class="login-card fade-in">
    <div class="login-badge">ğŸ” <span id="txt-secure">Secure Government Portal</span></div>
    <div class="login-heading" id="txt-portal-login">JalRakshak Login</div>
    <div class="login-subtitle" id="txt-login-desc">Authenticate to access drought monitoring, water tanker allocation, and field operations management for your jurisdiction.</div>

    <div style="margin-bottom:1rem;">
      <div class="form-label" id="txt-select-role">Select Your Role / à¤­à¥‚à¤®à¤¿à¤•à¤¾ à¤šà¥à¤¨à¥‡à¤‚</div>
      <div class="role-grid">
        <div class="role-card" id="role-collector" onclick="selectRole('collector')">
          <div class="role-icon">ğŸ›ï¸</div>
          <div class="role-name" id="txt-role-collector">District Collector</div>
        </div>
        <div class="role-card" id="role-officer" onclick="selectRole('officer')">
          <div class="role-icon">ğŸ‘·</div>
          <div class="role-name" id="txt-role-officer">Field Officer</div>
        </div>
        <div class="role-card" id="role-sarpanch" onclick="selectRole('sarpanch')">
          <div class="role-icon">ğŸ˜ï¸</div>
          <div class="role-name" id="txt-role-sarpanch">Sarpanch / Village Rep</div>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label" id="txt-state-label">State / à¤°à¤¾à¤œà¥à¤¯</label>
      <select class="form-control" id="stateSelect" onchange="onStateChange()">
        <option value="">-- Select State --</option>
        <option value="MH">Maharashtra</option>
        <option value="UP">Uttar Pradesh</option>
        <option value="RJ">Rajasthan</option>
        <option value="MP">Madhya Pradesh</option>
        <option value="GJ">Gujarat</option>
        <option value="KA">Karnataka</option>
        <option value="TN">Tamil Nadu</option>
        <option value="AP">Andhra Pradesh</option>
        <option value="TS">Telangana</option>
        <option value="JH">Jharkhand</option>
        <option value="OD">Odisha</option>
        <option value="BR">Bihar</option>
        <option value="WB">West Bengal</option>
        <option value="PB">Punjab</option>
        <option value="HR">Haryana</option>
        <option value="HP">Himachal Pradesh</option>
        <option value="CG">Chhattisgarh</option>
        <option value="KL">Kerala</option>
        <option value="AS">Assam</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label" id="txt-district-label">District / à¤œà¤¿à¤²à¤¾</label>
      <select class="form-control" id="districtSelect" onchange="onDistrictChange()" disabled>
        <option value="">-- Select District --</option>
      </select>
    </div>

    <div id="village-select-group" class="form-group hidden">
      <label class="form-label">Village / à¤—à¥à¤°à¤¾à¤®</label>
      <select class="form-control" id="villageSelect">
        <option value="">-- Select Village --</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label" id="txt-mobile-label">Mobile Number / à¤®à¥‹à¤¬à¤¾à¤‡à¤² à¤¨à¤‚à¤¬à¤°</label>
      <div style="display:flex;gap:0.5rem;">
        <input class="form-control" style="width:60px;" value="+91" readonly>
        <input class="form-control" id="mobileInput" type="tel" maxlength="10" placeholder="Enter 10-digit mobile number" oninput="this.value=this.value.replace(/\D/g,'')">
      </div>
    </div>

    <div id="otp-section" class="hidden">
      <div class="otp-display">
        <div style="font-size:0.8rem;color:#1B5E20;margin-bottom:0.4rem;">ğŸ“± OTP sent to your mobile</div>
        <div class="otp-code-display" id="demo-otp">----</div>
        <div style="font-size:0.72rem;color:#388E3C;margin-top:0.3rem;">âš ï¸ Demo mode â€” OTP shown above</div>
      </div>
      <div class="form-group">
        <label class="form-label">Enter OTP</label>
        <input class="form-control otp-input" id="otpInput" type="text" maxlength="6" placeholder="â€¢ â€¢ â€¢ â€¢ â€¢ â€¢">
      </div>
    </div>

    <div id="send-otp-btn-wrap">
      <button class="btn-primary" onclick="sendOTP()">ğŸ“± Send OTP</button>
    </div>
    <div id="verify-btn-wrap" class="hidden">
      <button class="btn-primary" onclick="verifyOTP()">âœ… Verify & Login</button>
      <div style="text-align:center;margin-top:0.8rem;">
        <button class="btn-secondary" style="font-size:0.78rem;" onclick="resetOTP()">â†© Change Number</button>
      </div>
    </div>

    <div class="divider"></div>
    <div style="text-align:center;font-size:0.72rem;color:var(--muted);">
      ğŸ”’ This portal is for authorized government officials only.<br>
      All activities are logged and audited. | NIC | GOI
    </div>
  </div>
</div>

<!-- â•â•â• DASHBOARD â•â•â• -->
<div id="dashboard-page" class="hidden">
  <div class="dashboard-layout">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-user">
        <div class="user-avatar" id="user-avatar">ğŸ›ï¸</div>
        <div class="user-name" id="user-name">User Name</div>
        <div class="user-role" id="user-role">District Collector</div>
        <div class="user-location" id="user-location">ğŸ“ Location</div>
      </div>

      <div class="sidebar-stats" id="sidebar-stats">
        <!-- filled dynamically -->
      </div>

      <nav class="sidebar-nav" id="sidebar-nav">
        <!-- filled dynamically per role -->
      </nav>

      <div class="sidebar-bottom">
        <div style="font-size:0.72rem;color:rgba(255,255,255,0.4);text-align:center;margin-bottom:0.7rem;">
          Session: <span id="session-time" style="font-family:monospace;"></span>
        </div>
        <button class="btn-logout" onclick="logout()">ğŸšª <span id="txt-logout">Logout</span></button>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content" id="main-content">
      <!-- Filled dynamically -->
    </main>
  </div>
</div>

<!-- â•â•â• FOOTER â•â•â• -->
<footer class="gov-footer">
  JalRakshak v2.0 | National Drought Management Portal | Ministry of Jal Shakti, Government of India | NIC | 
  <span style="color:rgba(255,255,255,0.3);">ğŸ” Secured | All rights reserved</span>
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let appState = {
  lang: 'en',
  role: null,
  state: null,
  district: null,
  village: null,
  activeTab: null,
  generatedOTP: null,
  sessionStart: Date.now(),
  user: null,
  villages: [],
  mapInstance: null,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDIA DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DISTRICTS = {
  MH: [
    {id:'nagpur', name:'Nagpur', lat:21.1458, lng:79.0882},
    {id:'pune', name:'Pune', lat:18.5204, lng:73.8567},
    {id:'nashik', name:'Nashik', lat:19.9975, lng:73.7898},
    {id:'aurangabad', name:'Aurangabad', lat:19.8762, lng:75.3433},
    {id:'solapur', name:'Solapur', lat:17.6599, lng:75.9064},
    {id:'gadchiroli', name:'Gadchiroli', lat:20.1809, lng:80.0016},
    {id:'latur', name:'Latur', lat:18.4088, lng:76.5604},
    {id:'amravati', name:'Amravati', lat:20.9374, lng:77.7796},
    {id:'kolhapur', name:'Kolhapur', lat:16.7050, lng:74.2433},
    {id:'akola', name:'Akola', lat:20.7002, lng:77.0082},
    {id:'wardha', name:'Wardha', lat:20.7453, lng:78.6022},
    {id:'buldana', name:'Buldana', lat:20.5292, lng:76.1845},
  ],
  UP: [
    {id:'lucknow', name:'Lucknow', lat:26.8467, lng:80.9462},
    {id:'varanasi', name:'Varanasi', lat:25.3176, lng:82.9739},
    {id:'agra', name:'Agra', lat:27.1767, lng:78.0081},
    {id:'kanpur', name:'Kanpur', lat:26.4499, lng:80.3319},
    {id:'prayagraj', name:'Prayagraj', lat:25.4358, lng:81.8463},
    {id:'meerut', name:'Meerut', lat:28.9845, lng:77.7064},
    {id:'jhansi', name:'Jhansi', lat:25.4484, lng:78.5685},
    {id:'gorakhpur', name:'Gorakhpur', lat:26.7606, lng:83.3732},
    {id:'bareilly', name:'Bareilly', lat:28.3670, lng:79.4304},
    {id:'mathura', name:'Mathura', lat:27.4924, lng:77.6737},
  ],
  RJ: [
    {id:'jaipur', name:'Jaipur', lat:26.9124, lng:75.7873},
    {id:'jodhpur', name:'Jodhpur', lat:26.2389, lng:73.0243},
    {id:'udaipur', name:'Udaipur', lat:24.5854, lng:73.7125},
    {id:'bikaner', name:'Bikaner', lat:28.0229, lng:73.3119},
    {id:'ajmer', name:'Ajmer', lat:26.4499, lng:74.6399},
    {id:'kota', name:'Kota', lat:25.2138, lng:75.8648},
    {id:'barmer', name:'Barmer', lat:25.7521, lng:71.3967},
    {id:'jaisalmer', name:'Jaisalmer', lat:26.9157, lng:70.9083},
    {id:'alwar', name:'Alwar', lat:27.5634, lng:76.6346},
    {id:'sikar', name:'Sikar', lat:27.6094, lng:75.1398},
  ],
  JH: [
    {id:'ranchi', name:'Ranchi', lat:23.3441, lng:85.3096},
    {id:'dhanbad', name:'Dhanbad', lat:23.7957, lng:86.4304},
    {id:'jamshedpur', name:'Jamshedpur', lat:22.8046, lng:86.2029},
    {id:'bokaro', name:'Bokaro', lat:23.6693, lng:86.1511},
    {id:'hazaribagh', name:'Hazaribagh', lat:23.9925, lng:85.3637},
    {id:'dumka', name:'Dumka', lat:24.2690, lng:87.2490},
    {id:'palamu', name:'Palamu', lat:24.0292, lng:84.0710},
    {id:'giridih', name:'Giridih', lat:24.1902, lng:86.2988},
    {id:'deoghar', name:'Deoghar', lat:24.4853, lng:86.6950},
    {id:'koderma', name:'Koderma', lat:24.4636, lng:85.5956},
  ],
  KA: [
    {id:'bangalore', name:'Bangalore Urban', lat:12.9716, lng:77.5946},
    {id:'mysore', name:'Mysuru', lat:12.2958, lng:76.6394},
    {id:'dharwad', name:'Dharwad', lat:15.4589, lng:75.0078},
    {id:'dakshina', name:'Dakshina Kannada', lat:12.9141, lng:74.8560},
    {id:'ballari', name:'Ballari', lat:15.1394, lng:76.9214},
    {id:'kalaburagi', name:'Kalaburagi', lat:17.3297, lng:76.8343},
    {id:'bidar', name:'Bidar', lat:17.9104, lng:77.5199},
    {id:'raichur', name:'Raichur', lat:16.2120, lng:77.3439},
    {id:'tumkur', name:'Tumkur', lat:13.3409, lng:77.1015},
    {id:'shivamogga', name:'Shivamogga', lat:13.9299, lng:75.5681},
  ],
  GJ: [
    {id:'ahmedabad', name:'Ahmedabad', lat:23.0225, lng:72.5714},
    {id:'surat', name:'Surat', lat:21.1702, lng:72.8311},
    {id:'vadodara', name:'Vadodara', lat:22.3072, lng:73.1812},
    {id:'rajkot', name:'Rajkot', lat:22.3039, lng:70.8022},
    {id:'bhavnagar', name:'Bhavnagar', lat:21.7645, lng:72.1519},
    {id:'kutch', name:'Kutch', lat:23.7337, lng:69.8597},
    {id:'junagadh', name:'Junagadh', lat:21.5222, lng:70.4579},
    {id:'anand', name:'Anand', lat:22.5645, lng:72.9289},
  ],
  TS: [
    {id:'hyderabad', name:'Hyderabad', lat:17.3850, lng:78.4867},
    {id:'warangal', name:'Warangal', lat:17.9784, lng:79.5941},
    {id:'nizamabad', name:'Nizamabad', lat:18.6725, lng:78.0941},
    {id:'karimnagar', name:'Karimnagar', lat:18.4386, lng:79.1288},
    {id:'khammam', name:'Khammam', lat:17.2473, lng:80.1514},
    {id:'nalgonda', name:'Nalgonda', lat:17.0573, lng:79.2680},
    {id:'mahbubnagar', name:'Mahbubnagar', lat:16.7449, lng:77.9847},
  ],
  TN: [
    {id:'chennai', name:'Chennai', lat:13.0827, lng:80.2707},
    {id:'coimbatore', name:'Coimbatore', lat:11.0168, lng:76.9558},
    {id:'madurai', name:'Madurai', lat:9.9252, lng:78.1198},
    {id:'trichy', name:'Tiruchirappalli', lat:10.7905, lng:78.7047},
    {id:'salem', name:'Salem', lat:11.6643, lng:78.1460},
    {id:'tirunelveli', name:'Tirunelveli', lat:8.7139, lng:77.7567},
    {id:'erode', name:'Erode', lat:11.3410, lng:77.7172},
    {id:'dindigul', name:'Dindigul', lat:10.3624, lng:77.9695},
  ],
  MP: [
    {id:'bhopal', name:'Bhopal', lat:23.2599, lng:77.4126},
    {id:'indore', name:'Indore', lat:22.7196, lng:75.8577},
    {id:'jabalpur', name:'Jabalpur', lat:23.1815, lng:79.9864},
    {id:'gwalior', name:'Gwalior', lat:26.2183, lng:78.1828},
    {id:'ujjain', name:'Ujjain', lat:23.1828, lng:75.7772},
    {id:'sagar', name:'Sagar', lat:23.8388, lng:78.7378},
    {id:'rewa', name:'Rewa', lat:24.5362, lng:81.2997},
  ],
  OD: [
    {id:'bhubaneswar', name:'Bhubaneswar', lat:20.2961, lng:85.8245},
    {id:'cuttack', name:'Cuttack', lat:20.4625, lng:85.8828},
    {id:'rourkela', name:'Rourkela', lat:22.2604, lng:84.8536},
    {id:'sambalpur', name:'Sambalpur', lat:21.4669, lng:83.9812},
    {id:'koraput', name:'Koraput', lat:18.8135, lng:82.7111},
    {id:'rayagada', name:'Rayagada', lat:19.1701, lng:83.4158},
  ],
  BR: [
    {id:'patna', name:'Patna', lat:25.5941, lng:85.1376},
    {id:'gaya', name:'Gaya', lat:24.7914, lng:85.0002},
    {id:'muzaffarpur', name:'Muzaffarpur', lat:26.1209, lng:85.3647},
    {id:'bhagalpur', name:'Bhagalpur', lat:25.2425, lng:86.9842},
    {id:'darbhanga', name:'Darbhanga', lat:26.1542, lng:85.8918},
  ],
  WB: [
    {id:'kolkata', name:'Kolkata', lat:22.5726, lng:88.3639},
    {id:'howrah', name:'Howrah', lat:22.5958, lng:88.2636},
    {id:'durgapur', name:'Durgapur', lat:23.4794, lng:87.3200},
    {id:'siliguri', name:'Siliguri', lat:26.7271, lng:88.3953},
    {id:'asansol', name:'Asansol', lat:23.6839, lng:86.9524},
  ],
  PB: [
    {id:'amritsar', name:'Amritsar', lat:31.6340, lng:74.8723},
    {id:'ludhiana', name:'Ludhiana', lat:30.9010, lng:75.8573},
    {id:'jalandhar', name:'Jalandhar', lat:31.3260, lng:75.5762},
    {id:'patiala', name:'Patiala', lat:30.3398, lng:76.3869},
    {id:'bathinda', name:'Bathinda', lat:30.2110, lng:74.9455},
  ],
  HR: [
    {id:'gurugram', name:'Gurugram', lat:28.4595, lng:77.0266},
    {id:'faridabad', name:'Faridabad', lat:28.4089, lng:77.3178},
    {id:'ambala', name:'Ambala', lat:30.3782, lng:76.7767},
    {id:'hisar', name:'Hisar', lat:29.1490, lng:75.7217},
    {id:'rohtak', name:'Rohtak', lat:28.8955, lng:76.6066},
  ],
  HP: [
    {id:'shimla', name:'Shimla', lat:31.1048, lng:77.1734},
    {id:'mandi', name:'Mandi', lat:31.7088, lng:76.9320},
    {id:'kangra', name:'Kangra', lat:32.0998, lng:76.2691},
    {id:'kullu', name:'Kullu', lat:31.9573, lng:77.1095},
  ],
  CG: [
    {id:'raipur', name:'Raipur', lat:21.2514, lng:81.6296},
    {id:'bilaspur', name:'Bilaspur', lat:22.0796, lng:82.1391},
    {id:'durg', name:'Durg', lat:21.1904, lng:81.2849},
    {id:'korba', name:'Korba', lat:22.3595, lng:82.7501},
  ],
  KL: [
    {id:'thiruvananthapuram', name:'Thiruvananthapuram', lat:8.5241, lng:76.9366},
    {id:'kochi', name:'Ernakulam', lat:9.9312, lng:76.2673},
    {id:'kozhikode', name:'Kozhikode', lat:11.2588, lng:75.7804},
    {id:'thrissur', name:'Thrissur', lat:10.5276, lng:76.2144},
  ],
  AS: [
    {id:'guwahati', name:'Kamrup Metro', lat:26.1445, lng:91.7362},
    {id:'dibrugarh', name:'Dibrugarh', lat:27.4728, lng:94.9120},
    {id:'silchar', name:'Cachar', lat:24.8333, lng:92.7789},
    {id:'jorhat', name:'Jorhat', lat:26.7509, lng:94.2037},
  ],
};

// Generate realistic village names by state
const VILLAGE_PREFIXES = {
  MH: ['Ram','Shiva','Kali','Dhano','Kur','Cha','Mul','Bha','Sir','Eta','Ahe','Dha','Wan','Mor','Nam','Wagh','Peth','Sin','Nav','Chi'],
  UP: ['Ram','Shyam','Dev','Hari','Kali','Bhu','Chan','Gau','Man','Sur','Nat','Bha','Gop','Mad','Soni','Pila','Bela','Koti','Sawa','Biha'],
  RJ: ['Jam','Bha','Sojat','Pali','Mer','Khe','Jhal','Dig','Nat','Bar','Cher','Pok','Tal','Gho','Sar','Bah','Deh','Kit','Mand','Nag'],
  JH: ['Bes','Tam','Ton','Ran','Cha','Dha','Bhu','Ber','Kem','Sal','Tor','Dum','Pal','Gha','Kan','Deo','Pak','Tik','Nam','Sim'],
  KA: ['Chik','Hul','Kur','Shi','Han','Ron','Bai','Hos','Mul','Kop','Cha','Kal','Gad','Mal','Sir','Bel','Hav','Dev','Soo','Mad'],
  GJ: ['Lim','Pal','San','Vas','Mor','Dha','Tra','Cha','Bha','Man','Tar','Kan','Had','Gam','Pet','Vis','Deh','Nar','Sav','Khe'],
  TS: ['Siri','Kol','Nag','Pam','Wad','Man','Kur','Sur','Kel','Niz','Tan','Ven','Pal','Sath','Che','Mak','Yad','Mah','Kod','Pen'],
  TN: ['Koo','Thi','Man','Kar','Pon','Vel','Cha','Per','Mad','Sri','Kol','Nam','Pul','Ara','Tir','Siv','Pal','Sat','Kud','Nar'],
  DEFAULT: ['Raj','Ram','Hari','Dev','Shiv','Bal','Man','Sur','Par','Kri','Gau','Nat','Pra','Cha','Ma','Ban','Dan','Nar','Son','Pat'],
};
const VILLAGE_SUFFIXES = ['pur','gaon','wadi','nagar','palli','pura','kheda','gram','basti','tanda','peth','wad','abad','garh','dih','khas','gunj','ganj','haven','khand'];

function generateVillages(districtId, statCode, lat, lng, count = 16) {
  const prefixes = VILLAGE_PREFIXES[statCode] || VILLAGE_PREFIXES.DEFAULT;
  const villages = [];
  const usedNames = new Set();
  for (let i = 0; i < count; i++) {
    let name;
    do {
      const p = prefixes[Math.floor(Math.random() * prefixes.length)];
      const s = VILLAGE_SUFFIXES[Math.floor(Math.random() * VILLAGE_SUFFIXES.length)];
      name = p + s;
    } while (usedNames.has(name));
    usedNames.add(name);

    const dlat = (Math.random() - 0.5) * 1.4;
    const dlng = (Math.random() - 0.5) * 1.4;
    const pop = Math.floor(Math.random() * 7500) + 600;
    const rainDeficit = Math.floor(Math.random() * 75) + 10;
    const gwDrop = +(Math.random() * 3.5).toFixed(1);
    const histFreq = Math.floor(Math.random() * 80);
    const popDensity = Math.floor(Math.random() * 80);
    const daysNoRain = Math.floor(Math.random() * 38);
    const wsi = Math.min(100, Math.round(
      rainDeficit * 0.30 + gwDrop * 25 * 0.25 +
      histFreq * 0.20 + popDensity * 0.15 +
      (daysNoRain / 0.38) * 0.10
    ));
    const daysMod = Math.floor(Math.random() * 18) + 3;
    villages.push({
      id: `${districtId}_v${i}`,
      name,
      lat: lat + dlat,
      lng: lng + dlng,
      population: pop,
      households: Math.floor(pop / 4.8),
      rainDeficit, gwDrop, histFreq, popDensity, daysNoRain, wsi,
      lastRain: `Feb ${Math.max(1, 23-daysNoRain)}, 2026`,
      borewellsOk: Math.floor(Math.random() * 4) + 1,
      borewellsTotal: Math.floor(Math.random() * 3) + 3,
      lastTankerDate: `Feb ${Math.max(1,23-daysMod)}, 2026`,
      lastTankerLitres: (Math.floor(Math.random() * 4) + 6) * 1000,
      waterAvailDays: Math.floor(Math.random() * 12) + 2,
      tankerAssigned: Math.random() > 0.4 ? `TK-${String(Math.floor(Math.random()*12)+1).padStart(2,'0')}` : 'Pending',
    });
  }
  return villages.sort((a, b) => b.wsi - a.wsi);
}

function getWSILevel(wsi) {
  if (wsi < 30) return { label:'Normal', color:'#2E7D32', bg:'#E8F5E9', emoji:'ğŸŸ¢', cls:'badge-normal' };
  if (wsi < 60) return { label:'Watch', color:'#F9A825', bg:'#FFFDE7', emoji:'ğŸŸ¡', cls:'badge-watch' };
  if (wsi < 80) return { label:'Warning', color:'#E65100', bg:'#FFF3E0', emoji:'ğŸŸ ', cls:'badge-warning' };
  return { label:'Critical', color:'#C62828', bg:'#FFEBEE', emoji:'ğŸ”´', cls:'badge-critical' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSLATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LANG_STRINGS = {
  en: { role:'Select Your Role', collector:'District Collector', officer:'Field Officer', sarpanch:'Gram Panchayat Sarpanch', logout:'Logout', secure:'Secure Government Portal' },
  hi: { role:'à¤…à¤ªà¤¨à¥€ à¤­à¥‚à¤®à¤¿à¤•à¤¾ à¤šà¥à¤¨à¥‡à¤‚', collector:'à¤œà¤¿à¤²à¤¾à¤§à¤¿à¤•à¤¾à¤°à¥€', officer:'à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤…à¤§à¤¿à¤•à¤¾à¤°à¥€', sarpanch:'à¤—à¥à¤°à¤¾à¤® à¤ªà¤‚à¤šà¤¾à¤¯à¤¤ à¤¸à¤°à¤ªà¤‚à¤š', logout:'à¤²à¥‰à¤—à¤†à¤‰à¤Ÿ', secure:'à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤¸à¤°à¤•à¤¾à¤°à¥€ à¤ªà¥‹à¤°à¥à¤Ÿà¤²' },
  mr: { role:'à¤†à¤ªà¤²à¥€ à¤­à¥‚à¤®à¤¿à¤•à¤¾ à¤¨à¤¿à¤µà¤¡à¤¾', collector:'à¤œà¤¿à¤²à¥à¤¹à¤¾à¤§à¤¿à¤•à¤¾à¤°à¥€', officer:'à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤…à¤§à¤¿à¤•à¤¾à¤°à¥€', sarpanch:'à¤—à¥à¤°à¤¾à¤®à¤ªà¤‚à¤šà¤¾à¤¯à¤¤ à¤¸à¤°à¤ªà¤‚à¤š', logout:'à¤²à¥‰à¤—à¤†à¤‰à¤Ÿ', secure:'à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤¸à¤°à¤•à¤¾à¤°à¥€ à¤ªà¥‹à¤°à¥à¤Ÿà¤²' },
  te: { role:'à°®à±€ à°ªà°¾à°¤à±à°°à°¨à± à°à°‚à°šà±à°•à±‹à°‚à°¡à°¿', collector:'à°œà°¿à°²à±à°²à°¾ à°•à°²à±†à°•à±à°Ÿà°°à±', officer:'à°«à±€à°²à±à°¡à± à°…à°§à°¿à°•à°¾à°°à°¿', sarpanch:'à°—à±à°°à°¾à°® à°ªà°‚à°šà°¾à°¯à°¤à±€ à°¸à°°à±à°ªà°‚à°šà±', logout:'à°²à°¾à°—à±à°…à°µà±à°Ÿà±', secure:'à°¸à±à°°à°•à±à°·à°¿à°¤ à°ªà±à°°à°­à±à°¤à±à°µ à°ªà±‹à°°à±à°Ÿà°²à±' },
  ta: { role:'à®‰à®™à¯à®•à®³à¯ à®ªà®¾à®¤à¯à®¤à®¿à®°à®¤à¯à®¤à¯ˆ à®¤à¯‡à®°à¯à®¨à¯à®¤à¯†à®Ÿà¯à®•à¯à®•à®µà¯à®®à¯', collector:'à®®à®¾à®µà®Ÿà¯à®Ÿ à®†à®Ÿà¯à®šà®¿à®¯à®°à¯', officer:'à®•à®³à®ªà¯à®ªà®£à®¿ à®…à®¤à®¿à®•à®¾à®°à®¿', sarpanch:'à®•à®¿à®°à®¾à®® à®ªà®à¯à®šà®¾à®¯à®¤à¯à®¤à¯ à®¤à®²à¯ˆà®µà®°à¯', logout:'à®µà¯†à®³à®¿à®¯à¯‡à®±à¯', secure:'à®ªà®¾à®¤à¯à®•à®¾à®ªà¯à®ªà®¾à®© à®…à®°à®šà¯ à®ªà¯‹à®°à¯à®Ÿà®²à¯' },
  kn: { role:'à²¨à²¿à²®à³à²® à²ªà²¾à²¤à³à²° à²†à²¯à³à²•à³†à²®à²¾à²¡à²¿', collector:'à²œà²¿à²²à³à²²à²¾ à²†à²¯à³à²•à³à²¤', officer:'à²•à³à²·à³‡à²¤à³à²° à²…à²§à²¿à²•à²¾à²°à²¿', sarpanch:'à²—à³à²°à²¾à²® à²ªà²‚à²šà²¾à²¯à²¤à³ à²¸à²°à³à²ªà²‚à²šà³', logout:'à²²à²¾à²—à³ à²”à²Ÿà³', secure:'à²¸à³à²°à²•à³à²·à²¿à²¤ à²¸à²°à³à²•à²¾à²°à²¿ à²ªà³‹à²°à³à²Ÿà²²à³' },
  gu: { role:'àª¤àª®àª¾àª°à«€ àª­à«‚àª®àª¿àª•àª¾ àªªàª¸àª‚àª¦ àª•àª°à«‹', collector:'àªœàª¿àª²à«àª²àª¾ àª•àª²à«‡àª•à«àªŸàª°', officer:'àª•à«àª·à«‡àª¤à«àª° àª…àª§àª¿àª•àª¾àª°à«€', sarpanch:'àª—à«àª°àª¾àª® àªªàª‚àªšàª¾àª¯àª¤ àª¸àª°àªªàª‚àªš', logout:'àª²à«‰àª— àª†àª‰àªŸ', secure:'àª¸à«àª°àª•à«àª·àª¿àª¤ àª¸àª°àª•àª¾àª°à«€ àªªà«‹àª°à«àªŸàª²' },
  bn: { role:'à¦†à¦ªà¦¨à¦¾à¦° à¦­à§‚à¦®à¦¿à¦•à¦¾ à¦¨à¦¿à¦°à§à¦¬à¦¾à¦šà¦¨ à¦•à¦°à§à¦¨', collector:'à¦œà§‡à¦²à¦¾ à¦¸à¦‚à¦—à§à¦°à¦¾à¦¹à¦•', officer:'à¦«à¦¿à¦²à§à¦¡ à¦…à¦«à¦¿à¦¸à¦¾à¦°', sarpanch:'à¦—à§à¦°à¦¾à¦® à¦ªà¦à§à¦šà¦¾à¦¯à¦¼à§‡à¦¤ à¦¸à¦°à¦ªà¦à§à¦š', logout:'à¦²à¦—à¦†à¦‰à¦Ÿ', secure:'à¦¸à§à¦°à¦•à§à¦·à¦¿à¦¤ à¦¸à¦°à¦•à¦¾à¦°à¦¿ à¦ªà§‹à¦°à§à¦Ÿà¦¾à¦²' },
  ml: { role:'à´¨à´¿à´™àµà´™à´³àµà´Ÿàµ† à´±àµ‹àµ¾ à´¤à´¿à´°à´àµà´àµ†à´Ÿàµà´•àµà´•àµà´•', collector:'à´œà´¿à´²àµà´²à´¾ à´•à´³à´•àµà´Ÿàµ¼', officer:'à´«àµ€àµ½à´¡àµ à´“à´«àµ€à´¸àµ¼', sarpanch:'à´—àµà´°à´¾à´® à´ªà´àµà´šà´¾à´¯à´¤àµà´¤àµ à´¸àµ¼à´ªà´àµà´šàµ', logout:'à´²àµ‹à´—àµ à´”à´Ÿàµà´Ÿàµ', secure:'à´¸àµà´°à´•àµà´·à´¿à´¤ à´—à´µàµºà´®àµ†à´¨àµà´±àµ à´ªàµ‹àµ¼à´Ÿàµà´Ÿàµ½' },
  or: { role:'à¬†à¬ªà¬£à¬™à­à¬• à¬­à­‚à¬®à¬¿à¬•à¬¾ à¬¬à¬¾à¬›à¬¨à­à¬¤à­', collector:'à¬œà¬¿à¬²à­à¬²à¬¾ à¬¸à¬‚à¬—à­à¬°à¬…', officer:'à¬«à¬¿à¬²à­à¬¡ à¬…à¬«à¬¿à¬¸à¬°', sarpanch:'à¬—à­à¬°à¬¾à¬® à¬ªà¬à­à¬šà¬¾à­Ÿà¬¤ à¬¸à¬°à¬ªà¬à­à¬š', logout:'à¬²à¬—à¬†à¬‰à¬Ÿ', secure:'à¬¸à­à¬°à¬•à­à¬·à¬¿à¬¤ à¬¸à¬°à¬•à¬¾à¬°à­€ à¬ªà­‹à¬°à­à¬Ÿà¬¾à¬²' },
  pa: { role:'à¨†à¨ªà¨£à©€ à¨­à©‚à¨®à¨¿à¨•à¨¾ à¨šà©à¨£à©‹', collector:'à¨œà¨¼à¨¿à¨²à©à¨¹à¨¾ à¨•à©à¨²à©ˆà¨•à¨Ÿà¨°', officer:'à¨«à©€à¨²à¨¡ à¨…à¨«à¨¸à¨°', sarpanch:'à¨—à©à¨°à¨¾à¨® à¨ªà©°à¨šà¨¾à¨‡à¨¤ à¨¸à¨°à¨ªà©°à¨š', logout:'à¨²à¨¾à¨— à¨†à¨Šà¨Ÿ', secure:'à¨¸à©à¨°à©±à¨–à¨¿à¨…à¨¤ à¨¸à¨°à¨•à¨¾à¨°à©€ à¨ªà©‹à¨°à¨Ÿà¨²' },
};

function t(key) {
  const dict = LANG_STRINGS[appState.lang] || LANG_STRINGS.en;
  return dict[key] || LANG_STRINGS.en[key] || key;
}

function changeLang(lang) {
  appState.lang = lang;
  document.getElementById('txt-select-role').textContent = t('role') + ' / Select Your Role';
  document.getElementById('txt-role-collector').textContent = t('collector');
  document.getElementById('txt-role-officer').textContent = t('officer');
  document.getElementById('txt-role-sarpanch').textContent = t('sarpanch');
  document.getElementById('txt-secure').textContent = t('secure');
  document.getElementById('txt-logout').textContent = t('logout');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function selectRole(role) {
  appState.role = role;
  document.querySelectorAll('.role-card').forEach(c => c.classList.remove('active'));
  document.getElementById(`role-${role}`).classList.add('active');

  // Show village selector only for sarpanch
  if (role === 'sarpanch') {
    document.getElementById('village-select-group').classList.remove('hidden');
  } else {
    document.getElementById('village-select-group').classList.add('hidden');
  }
}

function onStateChange() {
  const stateCode = document.getElementById('stateSelect').value;
  appState.state = stateCode;
  const distSelect = document.getElementById('districtSelect');
  distSelect.innerHTML = '<option value="">-- Select District --</option>';
  distSelect.disabled = !stateCode;

  if (stateCode && DISTRICTS[stateCode]) {
    DISTRICTS[stateCode].forEach(d => {
      distSelect.innerHTML += `<option value="${d.id}" data-lat="${d.lat}" data-lng="${d.lng}">${d.name}</option>`;
    });
    distSelect.disabled = false;
  }
  document.getElementById('villageSelect').innerHTML = '<option value="">-- Select Village --</option>';
}

function onDistrictChange() {
  const distSelect = document.getElementById('districtSelect');
  const opt = distSelect.options[distSelect.selectedIndex];
  if (!opt.value) return;

  appState.district = { id: opt.value, name: opt.text, lat: parseFloat(opt.dataset.lat), lng: parseFloat(opt.dataset.lng) };

  // Generate villages for this district
  appState.villages = generateVillages(opt.value, appState.state, appState.district.lat, appState.district.lng);

  const villageSelect = document.getElementById('villageSelect');
  villageSelect.innerHTML = '<option value="">-- Select Village --</option>';
  appState.villages.forEach(v => {
    villageSelect.innerHTML += `<option value="${v.id}">${v.name}</option>`;
  });
}

function sendOTP() {
  const mobile = document.getElementById('mobileInput').value;
  if (!appState.role) { alert('Please select your role first.'); return; }
  if (!appState.state) { alert('Please select a state.'); return; }
  if (!appState.district) { alert('Please select a district.'); return; }
  if (mobile.length !== 10) { alert('Please enter a valid 10-digit mobile number.'); return; }

  if (appState.role === 'sarpanch') {
    const vId = document.getElementById('villageSelect').value;
    if (!vId) { alert('Please select your village.'); return; }
    appState.village = appState.villages.find(v => v.id === vId);
  }

  appState.generatedOTP = String(Math.floor(100000 + Math.random() * 900000));
  document.getElementById('demo-otp').textContent = appState.generatedOTP;
  document.getElementById('otp-section').classList.remove('hidden');
  document.getElementById('send-otp-btn-wrap').classList.add('hidden');
  document.getElementById('verify-btn-wrap').classList.remove('hidden');
}

function resetOTP() {
  document.getElementById('otp-section').classList.add('hidden');
  document.getElementById('send-otp-btn-wrap').classList.remove('hidden');
  document.getElementById('verify-btn-wrap').classList.add('hidden');
  document.getElementById('otpInput').value = '';
  appState.generatedOTP = null;
}

function verifyOTP() {
  const entered = document.getElementById('otpInput').value;
  if (entered === appState.generatedOTP) {
    loginSuccess();
  } else {
    alert('âŒ Incorrect OTP. Please check and try again.\n\nHint: The OTP is shown in the green box above for demo purposes.');
  }
}

const USER_NAMES = {
  collector: ['Shri Anil Kumar Sharma IAS','Smt. Priya Menon IAS','Shri Rajendra Singh IAS','Smt. Kavitha Reddy IAS','Shri Suresh Babu IAS'],
  officer: ['Suresh Deshmukh','Priya Nair','Ramkumar Yadav','Lalitha Devi','Mohan Kumar','Anjali Patil'],
  sarpanch: ['Ramrao Bhoyar','Savitri Devi','Panchsheel Kumar','Lalita Naitam','Govinda Tekam'],
};

function loginSuccess() {
  const names = USER_NAMES[appState.role];
  appState.user = {
    name: names[Math.floor(Math.random() * names.length)],
    role: appState.role,
    state: appState.state,
    district: appState.district,
    village: appState.village,
  };

  document.getElementById('login-page').classList.add('hidden');
  document.getElementById('dashboard-page').classList.remove('hidden');

  setupDashboard();
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    appState = { lang: appState.lang, role: null, state: null, district: null, village: null, activeTab: null, generatedOTP: null, sessionStart: Date.now(), user: null, villages: [], mapInstance: null };
    document.getElementById('login-page').classList.remove('hidden');
    document.getElementById('dashboard-page').classList.add('hidden');
    document.getElementById('mobileInput').value = '';
    document.getElementById('otpInput').value = '';
    document.getElementById('otp-section').classList.add('hidden');
    document.getElementById('send-otp-btn-wrap').classList.remove('hidden');
    document.getElementById('verify-btn-wrap').classList.add('hidden');
    document.querySelectorAll('.role-card').forEach(c => c.classList.remove('active'));
    document.getElementById('stateSelect').value = '';
    document.getElementById('districtSelect').innerHTML = '<option value="">-- Select District --</option>';
    document.getElementById('districtSelect').disabled = true;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setupDashboard() {
  const u = appState.user;
  const roleEmoji = { collector: 'ğŸ›ï¸', officer: 'ğŸ‘·', sarpanch: 'ğŸ˜ï¸' }[u.role];
  const roleLabel = { collector: 'District Collector', officer: 'Field Officer', sarpanch: 'Sarpanch' }[u.role];

  document.getElementById('user-avatar').textContent = roleEmoji;
  document.getElementById('user-name').textContent = u.name;
  document.getElementById('user-role').textContent = t(u.role);

  let locationStr = `${u.district.name}, ${u.state}`;
  if (u.role === 'sarpanch' && u.village) locationStr = `${u.village.name} Village, ${u.district.name}`;
  document.getElementById('user-location').innerHTML = `ğŸ“ ${locationStr}`;

  setupSidebarStats();
  setupSidebarNav();

  // Load first tab
  if (u.role === 'collector') loadCollectorTab('overview');
  else if (u.role === 'officer') loadOfficerTab('queue');
  else loadSarpanchTab('status');
}

function setupSidebarStats() {
  const v = appState.villages;
  const critical = v.filter(x => x.wsi >= 80).length;
  const warning = v.filter(x => x.wsi >= 60 && x.wsi < 80).length;
  const avgWSI = Math.round(v.reduce((a, b) => a + b.wsi, 0) / v.length);

  let html = '';
  if (appState.user.role === 'sarpanch' && appState.village) {
    const sv = appState.village;
    const level = getWSILevel(sv.wsi);
    html = `
      <div class="stat-item"><span>Village WSI</span><span class="stat-val" style="color:${level.color}">${sv.wsi}</span></div>
      <div class="stat-item"><span>Alert Level</span><span class="stat-val" style="color:${level.color}">${level.emoji} ${level.label}</span></div>
      <div class="stat-item"><span>Days No Rain</span><span class="stat-val orange">${sv.daysNoRain}d</span></div>
      <div class="stat-item"><span>Water in Days</span><span class="stat-val red">${sv.waterAvailDays}d</span></div>
      <div class="stat-item"><span>Borewells OK</span><span class="stat-val green">${sv.borewellsOk}/${sv.borewellsTotal}</span></div>
    `;
  } else {
    html = `
      <div class="stat-item"><span>Total Villages</span><span class="stat-val">${v.length}</span></div>
      <div class="stat-item"><span>ğŸ”´ Critical</span><span class="stat-val red">${critical}</span></div>
      <div class="stat-item"><span>ğŸŸ  Warning</span><span class="stat-val orange">${warning}</span></div>
      <div class="stat-item"><span>Avg WSI</span><span class="stat-val">${avgWSI}</span></div>
      <div class="stat-item"><span>Tankers Active</span><span class="stat-val green">${Math.floor(Math.random()*6)+3}</span></div>
    `;
  }
  document.getElementById('sidebar-stats').innerHTML = html;
}

function setupSidebarNav() {
  const role = appState.user.role;
  const navConfigs = {
    collector: [
      { key:'overview', icon:'ğŸ“Š', label:'Command Overview' },
      { key:'riskmap', icon:'ğŸ—ºï¸', label:'District Risk Map' },
      { key:'ranking', icon:'ğŸ“‹', label:'Village Ranking' },
      { key:'tankers', icon:'ğŸš›', label:'Tanker Allocation' },
      { key:'forecast', icon:'ğŸ”®', label:'Demand Forecast' },
      { key:'twin', icon:'ğŸ›ï¸', label:'Digital Twin Simulator' },
      { key:'budget', icon:'ğŸ’°', label:'Budget & Fleet' },
      { key:'alerts', icon:'ğŸš¨', label:'Policy Alerts' },
    ],
    officer: [
      { key:'queue', icon:'ğŸ—‚ï¸', label:'Priority Queue' },
      { key:'fleet', icon:'ğŸš›', label:'Fleet Status' },
      { key:'otp', icon:'ğŸ”‘', label:'Delivery OTP' },
      { key:'escalation', icon:'âš¡', label:'Escalation' },
      { key:'ground', icon:'ğŸ“¡', label:'Ground Truth' },
      { key:'route', icon:'ğŸ—ºï¸', label:'Route Optimizer' },
    ],
    sarpanch: [
      { key:'status', icon:'ğŸŒ¡ï¸', label:'Village Status' },
      { key:'request', icon:'ğŸ“', label:'Tanker Request' },
      { key:'tracker', icon:'ğŸš›', label:'Arrival Tracker' },
      { key:'history', icon:'ğŸ“¦', label:'Supply History' },
      { key:'board', icon:'ğŸ“£', label:'Community Board' },
    ],
  };

  const items = navConfigs[role];
  let html = '<div class="nav-section-label">NAVIGATION</div>';
  items.forEach(item => {
    html += `<div class="nav-item" id="nav-${item.key}" onclick="handleNav('${item.key}')">
      <span class="nav-icon">${item.icon}</span>
      <span>${item.label}</span>
    </div>`;
  });
  document.getElementById('sidebar-nav').innerHTML = html;
}

function setActiveNav(key) {
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  const el = document.getElementById(`nav-${key}`);
  if (el) el.classList.add('active');
  appState.activeTab = key;
}

function handleNav(key) {
  const role = appState.user.role;
  if (role === 'collector') loadCollectorTab(key);
  else if (role === 'officer') loadOfficerTab(key);
  else loadSarpanchTab(key);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLLECTOR DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function loadCollectorTab(tab) {
  setActiveNav(tab);
  const mc = document.getElementById('main-content');
  const u = appState.user;
  const v = appState.villages;
  const critical = v.filter(x => x.wsi >= 80).length;
  const warning = v.filter(x => x.wsi >= 60 && x.wsi < 80).length;
  const avgWSI = Math.round(v.reduce((a, b) => a + b.wsi, 0) / v.length);
  const maxVillage = v[0];

  const header = `<div class="page-header">
    <div>
      <div class="page-header-title">ğŸ›ï¸ District Command Center â€” ${u.district.name}</div>
      <div class="page-header-sub">ğŸ“ ${u.district.name} District, ${u.state} | ğŸš¨ Preventive Governance Mode | ${u.name}</div>
    </div>
    <div style="text-align:right;">
      <div style="font-size:0.72rem;color:rgba(255,255,255,0.6);">District WSI Average</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:2.5rem;font-weight:700;color:${avgWSI>60?'#FF8C38':'#FFD700'}">${avgWSI}</div>
    </div>
  </div>`;

  const metricsHtml = `<div class="metrics-row">
    <div class="metric-card"><div class="metric-icon">ğŸ˜ï¸</div><div class="metric-val">${v.length}</div><div class="metric-label">Total Villages</div></div>
    <div class="metric-card critical"><div class="metric-icon">ğŸ”´</div><div class="metric-val">${critical}</div><div class="metric-label">Critical (WSI â‰¥ 80)</div></div>
    <div class="metric-card warning"><div class="metric-icon">ğŸŸ </div><div class="metric-val">${warning}</div><div class="metric-label">Warning (60â€“79)</div></div>
    <div class="metric-card"><div class="metric-icon">ğŸ—ºï¸</div><div class="metric-val">${maxVillage.name}</div><div class="metric-label">Highest Risk Village</div></div>
  </div>`;

  if (tab === 'overview') {
    mc.innerHTML = header + metricsHtml + `
    <div class="alert alert-critical" style="display:${critical>0?'flex':'none'}">
      ğŸš¨ <div><strong>${critical} village(s) in CRITICAL status</strong> â€” Immediate intervention required. Auto-allocation recommended.</div>
    </div>
    <div class="card-2col">
      <div class="card">
        <div class="card-title">ğŸ“Š District WSI Distribution</div>
        <canvas id="wsiChart" height="200"></canvas>
      </div>
      <div class="card">
        <div class="card-title">ğŸŒ§ï¸ Rainfall Trend (12 months)</div>
        <canvas id="rainChart" height="200"></canvas>
      </div>
    </div>
    <div class="card-2col">
      <div class="card">
        <div class="card-title">ğŸš› Fleet Utilization Today</div>
        ${generateFleetOverview()}
      </div>
      <div class="card">
        <div class="card-title">ğŸš¨ Policy Decision Alerts</div>
        ${generatePolicyAlerts(v)}
      </div>
    </div>
    `;
    drawWSIChart(v);
    drawRainChart();
  }
  else if (tab === 'riskmap') {
    mc.innerHTML = header + metricsHtml + `
    <div class="card">
      <div class="card-title">ğŸ—ºï¸ Village Risk Map â€” ${u.district.name} District</div>
      <div style="margin-bottom:0.8rem;display:flex;gap:1rem;font-size:0.8rem;flex-wrap:wrap;">
        <span style="color:#2E7D32;">ğŸŸ¢ Normal (0â€“29)</span>
        <span style="color:#F9A825;">ğŸŸ¡ Watch (30â€“59)</span>
        <span style="color:#E65100;">ğŸŸ  Warning (60â€“79)</span>
        <span style="color:#C62828;">ğŸ”´ Critical (80â€“100)</span>
      </div>
      <div id="district-map"></div>
    </div>`;
    initMap('district-map', u.district.lat, u.district.lng, v, true);
  }
  else if (tab === 'ranking') {
    mc.innerHTML = header + metricsHtml + `
    <div class="card">
      <div class="card-title">ğŸ“‹ Village Priority Ranking â€” Auto-Sorted by WSI</div>
      <div style="overflow-x:auto;">
        <table class="village-table">
          <thead>
            <tr>
              <th>#</th><th>Village</th><th>WSI Score</th><th>Alert Level</th>
              <th>Days No Rain</th><th>Population</th><th>Tanker Status</th><th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${v.map((vill, i) => {
              const level = getWSILevel(vill.wsi);
              const tStatus = vill.tankerAssigned === 'Pending'
                ? `<span style="color:#C62828;font-weight:600;">â³ Pending</span>`
                : `<span style="color:#2E7D32;font-weight:600;">âœ… ${vill.tankerAssigned}</span>`;
              return `<tr>
                <td><strong style="color:var(--muted);">#${i+1}</strong></td>
                <td><strong>${vill.name}</strong></td>
                <td><strong style="color:${level.color};font-size:1.1rem;font-family:'Rajdhani',sans-serif;">${vill.wsi}</strong></td>
                <td><span class="badge ${level.cls}">${level.emoji} ${level.label}</span></td>
                <td style="color:${vill.daysNoRain>14?'#C62828':'#E65100'};font-weight:600;">${vill.daysNoRain}d</td>
                <td>${vill.population.toLocaleString()}</td>
                <td>${tStatus}</td>
                <td><button onclick="alert('Tanker request initiated for ${vill.name}')" style="background:var(--navy);color:white;border:none;padding:0.3rem 0.7rem;border-radius:6px;cursor:pointer;font-size:0.78rem;">Allocate</button></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
      <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--sand);display:flex;gap:0.8rem;">
        <button class="btn-primary" style="width:auto;padding:0.65rem 1.5rem;" onclick="alert('âœ… Tankers auto-allocated to top 5 critical villages!')">âš¡ Auto-Allocate to Critical Villages</button>
        <button class="btn-secondary" onclick="alert('ğŸ“Š Report exported to PDF')">ğŸ“Š Export Report</button>
      </div>
    </div>`;
  }
  else if (tab === 'tankers') {
    mc.innerHTML = header + `
    <div class="card-2col">
      <div class="card">
        <div class="card-title">ğŸš› Tanker Demand Forecast (7 Days)</div>
        ${generateTankerForecast()}
      </div>
      <div class="card">
        <div class="card-title">ğŸ—ºï¸ Fleet Route Optimization</div>
        ${generateRouteOpt(v)}
      </div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Tanker Allocation Plan</div>
      <div style="overflow-x:auto;">
        <table class="village-table">
          <thead>
            <tr><th>Village</th><th>WSI</th><th>Priority</th><th>Assigned Tanker</th><th>Scheduled ETA</th><th>Route (km)</th><th>Status</th></tr>
          </thead>
          <tbody>
            ${v.slice(0,8).map(vill => {
              const level = getWSILevel(vill.wsi);
              const km = Math.floor(Math.random()*40)+10;
              const hour = Math.floor(Math.random()*8)+8;
              const min = Math.random()>0.5?'30':'00';
              return `<tr>
                <td><strong>${vill.name}</strong></td>
                <td style="color:${level.color};font-weight:700;font-family:'Rajdhani',sans-serif;">${vill.wsi}</td>
                <td><span class="badge ${level.cls}">${level.label}</span></td>
                <td style="font-family:'IBM Plex Mono',monospace;color:var(--saffron);">${vill.tankerAssigned}</td>
                <td>${hour}:${min} AM</td>
                <td>${km} km</td>
                <td><span class="badge badge-normal">Approved</span></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>`;
  }
  else if (tab === 'forecast') {
    mc.innerHTML = header + `
    <div class="card">
      <div class="card-title">ğŸ”® 7-Day Water Demand Forecast</div>
      <canvas id="forecastChart" height="200"></canvas>
    </div>
    <div class="card-3col">
      ${['7 Days','14 Days','30 Days'].map((period, idx) => {
        const demand = Math.floor(Math.random()*50)+100;
        const shortage = Math.floor(demand * 0.3);
        return `<div class="card" style="margin-bottom:0;">
          <div class="card-title" style="font-size:0.95rem;">ğŸ“… Next ${period}</div>
          <div style="text-align:center;padding:1rem 0;">
            <div style="font-size:2.5rem;font-family:'Rajdhani',sans-serif;font-weight:700;color:var(--navy);">${demand}</div>
            <div style="font-size:0.78rem;color:var(--muted);">Tanker trips required</div>
            <div style="margin-top:0.7rem;padding:0.5rem;background:#FFEBEE;border-radius:8px;font-size:0.82rem;color:var(--red);">âš ï¸ Projected shortage: ${shortage} trips</div>
          </div>
        </div>`;
      }).join('')}
    </div>`;
    drawForecastChart();
  }
  else if (tab === 'budget') {
    mc.innerHTML = header + `
    <div class="metrics-row">
      <div class="metric-card"><div class="metric-icon">ğŸ’°</div><div class="metric-val">â‚¹${(Math.floor(Math.random()*50)+100)}L</div><div class="metric-label">Budget Utilized</div></div>
      <div class="metric-card"><div class="metric-icon">â›½</div><div class="metric-val">${Math.floor(Math.random()*2000)+3000}L</div><div class="metric-label">Fuel Consumed (Today)</div></div>
      <div class="metric-card"><div class="metric-icon">ğŸš›</div><div class="metric-val">${Math.floor(Math.random()*4)+8}</div><div class="metric-label">Total Tankers Deployed</div></div>
      <div class="metric-card ok"><div class="metric-icon">ğŸ“Š</div><div class="metric-val">${Math.floor(Math.random()*20)+70}%</div><div class="metric-label">Fleet Utilization</div></div>
    </div>
    <div class="card-2col">
      <div class="card">
        <div class="card-title">ğŸ’° Budget Breakdown</div>
        <canvas id="budgetChart" height="200"></canvas>
      </div>
      <div class="card">
        <div class="card-title">ğŸš› Fleet Status Overview</div>
        ${generateFleetCards()}
      </div>
    </div>`;
    drawBudgetChart();
  }

  else if (tab === 'twin') {
    mc.innerHTML = header + `
    <div class="alert alert-info" style="margin-bottom:1rem;">
      ğŸ›ï¸ <div><strong>Digital Twin Simulator</strong> â€” Drag the sliders to simulate future drought scenarios. The map and metrics update live. This is the district planner's "What If" engine.</div>
    </div>
    <div class="card" style="border:2px solid var(--saffron);">
      <div class="card-title" style="font-size:1.1rem;">âš™ï¸ Scenario Control Panel â€” Drag to Simulate</div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1.8rem;">
        <div>
          <label class="form-label">ğŸŒ§ï¸ Rainfall Reduction: <span id="lbl-rain" style="color:var(--red);font-family:'IBM Plex Mono';font-size:1rem;">0%</span></label>
          <input type="range" id="sim-rain" min="0" max="80" value="0" style="width:100%;height:6px;accent-color:var(--red);cursor:pointer;" oninput="updateTwin()">
          <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--muted);margin-top:3px;"><span>Normal Rainfall</span><span>80% Deficit (Severe)</span></div>
        </div>
        <div>
          <label class="form-label">ğŸ“… Days Ahead: <span id="lbl-days" style="color:var(--navy);font-family:'IBM Plex Mono';font-size:1rem;">7</span></label>
          <input type="range" id="sim-days" min="7" max="30" value="7" style="width:100%;height:6px;accent-color:var(--navy);cursor:pointer;" oninput="updateTwin()">
          <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--muted);margin-top:3px;"><span>1 week</span><span>1 month</span></div>
        </div>
        <div>
          <label class="form-label">ğŸŒ¡ï¸ Temperature Anomaly: <span id="lbl-temp" style="color:var(--orange);font-family:'IBM Plex Mono';font-size:1rem;">+0Â°C</span></label>
          <input type="range" id="sim-temp" min="0" max="5" value="0" step="0.5" style="width:100%;height:6px;accent-color:var(--orange);cursor:pointer;" oninput="updateTwin()">
          <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--muted);margin-top:3px;"><span>Normal</span><span>+5Â°C Heatwave</span></div>
        </div>
        <div>
          <label class="form-label">ğŸ’§ Litres/Person/Day: <span id="lbl-lpd" style="color:var(--green);font-family:'IBM Plex Mono';font-size:1rem;">50L</span></label>
          <input type="range" id="sim-lpd" min="30" max="70" value="50" step="5" style="width:100%;height:6px;accent-color:var(--green);cursor:pointer;" oninput="updateTwin()">
          <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--muted);margin-top:3px;"><span>Crisis (30L)</span><span>Adequate (70L)</span></div>
        </div>
      </div>
      <div style="margin-top:1.2rem;display:flex;gap:0.8rem;">
        <button class="btn-primary" style="width:auto;padding:0.6rem 1.5rem;" onclick="updateTwin()">ğŸ”„ Recalculate Scenario</button>
        <button class="btn-secondary" onclick="resetTwin()">â†©ï¸ Reset to Baseline</button>
      </div>
    </div>
    <div class="metrics-row" id="twin-metrics">
      <div class="metric-card critical"><div class="metric-icon">ğŸ”´</div><div class="metric-val" id="twin-critical">0</div><div class="metric-label">Critical Villages</div></div>
      <div class="metric-card warning"><div class="metric-icon">ğŸš›</div><div class="metric-val" id="twin-tankers">0</div><div class="metric-label">Tankers Needed</div></div>
      <div class="metric-card"><div class="metric-icon">ğŸ“Š</div><div class="metric-val" id="twin-avgwsi">0</div><div class="metric-label">Projected Avg WSI</div></div>
      <div class="metric-card warning"><div class="metric-icon">ğŸ’°</div><div class="metric-val" id="twin-cost">0</div><div class="metric-label">Est. Cost (â‚¹ Lakh)</div></div>
    </div>
    <div class="card-2col">
      <div class="card">
        <div class="card-title">ğŸ—ºï¸ Simulated Risk Map â€” Red Zones Expand as Stress Increases</div>
        <div id="twin-map" style="height:340px;border-radius:8px;overflow:hidden;border:1px solid var(--border);"></div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“Š WSI Shift: Baseline vs Simulated</div>
        <canvas id="twinChart" height="270"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Village-Level Impact Table</div>
      <div id="twin-table" style="overflow-x:auto;"></div>
    </div>`;
    window._twinMap = null;
    window._twinChart = null;
    window._twinBaseWSI = appState.villages.map(v => v.wsi);
    setTimeout(() => updateTwin(), 50);
  }

  else if (tab === 'alerts') {
    mc.innerHTML = header + `
    <div class="card">
      <div class="card-title">ğŸš¨ Policy Decision Support Alerts</div>
      ${generatePolicyAlerts(v, true)}
    </div>
    <div class="card">
      <div class="card-title">ğŸ“ˆ Groundwater Trend Analysis</div>
      <canvas id="gwChart" height="200"></canvas>
    </div>`;
    drawGWChart();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OFFICER DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function loadOfficerTab(tab) {
  setActiveNav(tab);
  const mc = document.getElementById('main-content');
  const u = appState.user;
  const v = appState.villages;
  const critical = v.filter(x => x.wsi >= 60).length;

  const header = `<div class="page-header">
    <div>
      <div class="page-header-title">ğŸ‘· Field Operations Panel â€” ${u.district.name}</div>
      <div class="page-header-sub">ğŸ“ ${u.district.name} Zone | ${u.name} | Ground Execution Layer</div>
    </div>
    <div style="display:flex;gap:1.5rem;">
      <div style="text-align:center;"><div style="font-size:0.72rem;color:rgba(255,255,255,0.6);">In Transit</div><div style="font-family:'Rajdhani',sans-serif;font-size:2rem;font-weight:700;color:white;">${Math.floor(Math.random()*3)+2}</div></div>
      <div style="text-align:center;"><div style="font-size:0.72rem;color:rgba(255,255,255,0.6);">Critical Villages</div><div style="font-family:'Rajdhani',sans-serif;font-size:2rem;font-weight:700;color:#FF8C38;">${critical}</div></div>
    </div>
  </div>`;

  if (tab === 'queue') {
    mc.innerHTML = header + `
    <div class="metrics-row">
      <div class="metric-card"><div class="metric-icon">ğŸ˜ï¸</div><div class="metric-val">${v.length}</div><div class="metric-label">Villages in Zone</div></div>
      <div class="metric-card critical"><div class="metric-icon">âš ï¸</div><div class="metric-val">${critical}</div><div class="metric-label">In Warning/Critical</div></div>
      <div class="metric-card warning"><div class="metric-icon">â³</div><div class="metric-val">${v.filter(x=>x.tankerAssigned==='Pending').length}</div><div class="metric-label">Pending Assignment</div></div>
      <div class="metric-card"><div class="metric-icon">ğŸ“Š</div><div class="metric-val">${Math.round(v.reduce((a,b)=>a+b.wsi,0)/v.length)}</div><div class="metric-label">Zone Avg WSI</div></div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ—‚ï¸ Zone Priority Queue â€” Sorted by WSI</div>
      <table class="village-table">
        <thead>
          <tr><th>Rank</th><th>Village</th><th>WSI</th><th>Severity</th><th>Days No Supply</th><th>Population</th><th>Tanker</th><th>Action</th></tr>
        </thead>
        <tbody>
          ${v.slice(0,10).map((vill, i) => {
            const level = getWSILevel(vill.wsi);
            const daysNoSupply = Math.floor(Math.random()*6);
            const tColor = vill.tankerAssigned==='Pending' ? '#C62828' : '#2E7D32';
            return `<tr>
              <td><strong style="color:var(--muted);">#${i+1}</strong></td>
              <td><strong>${vill.name}</strong></td>
              <td style="color:${level.color};font-weight:700;font-size:1.05rem;font-family:'Rajdhani',sans-serif;">${vill.wsi}</td>
              <td><span class="badge ${level.cls}">${level.emoji} ${level.label}</span></td>
              <td style="color:${daysNoSupply>=3?'#C62828':'#E65100'};font-weight:600;">${daysNoSupply}d</td>
              <td>${vill.population.toLocaleString()}</td>
              <td style="font-family:'IBM Plex Mono',monospace;color:${tColor};font-weight:600;">${vill.tankerAssigned}</td>
              <td><button onclick="alert('Tanker assigned to ${vill.name}')" style="background:var(--saffron);color:white;border:none;padding:0.3rem 0.7rem;border-radius:5px;cursor:pointer;font-size:0.75rem;">Assign</button></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
    <div class="card">
      <div class="card-title">ğŸ—ºï¸ Zone Route Planning Map</div>
      <div id="officer-map"></div>
    </div>`;
    initMap('officer-map', u.district.lat, u.district.lng, v.slice(0,8), false);
  }
  else if (tab === 'fleet') {
    mc.innerHTML = header + `
    <div class="metrics-row">
      <div class="metric-card warning"><div class="metric-icon">ğŸš›</div><div class="metric-val">3</div><div class="metric-label">In Transit</div></div>
      <div class="metric-card ok"><div class="metric-icon">âœ…</div><div class="metric-val">2</div><div class="metric-label">Delivered Today</div></div>
      <div class="metric-card"><div class="metric-icon">ğŸ”µ</div><div class="metric-val">2</div><div class="metric-label">Available</div></div>
      <div class="metric-card critical"><div class="metric-icon">ğŸ”§</div><div class="metric-val">1</div><div class="metric-label">Under Maintenance</div></div>
    </div>
    <div class="card">
      <div class="card-title">ğŸš› Live Fleet Status</div>
      ${generateFleetCards(true)}
    </div>`;
  }
  else if (tab === 'otp') {
    mc.innerHTML = header + `
    <div class="alert alert-info">ğŸ” <div><strong>Delivery OTP Verification</strong> â€” Generate a 6-digit OTP before delivery. The Sarpanch confirms receipt by reading back the OTP to prevent fake delivery reporting.</div></div>
    <div class="card-2col">
      <div class="card">
        <div class="card-title">ğŸ”‘ Generate Delivery OTP</div>
        <div class="form-group">
          <label class="form-label">Select Pending Delivery</label>
          <select class="form-control" id="otp-delivery-select">
            ${v.filter(x=>x.tankerAssigned!=='Pending').slice(0,5).map(vill=>
              `<option value="${vill.id}">DEL-2026-${Math.floor(Math.random()*900)+100} â€” ${vill.name} (${vill.tankerAssigned})</option>`
            ).join('')}
          </select>
        </div>
        <button class="btn-primary" onclick="generateDeliveryOTP()">ğŸ”‘ Generate OTP</button>
        <div id="generated-otp-box" style="margin-top:1rem;display:none;">
          <div class="otp-display">
            <div style="font-size:0.85rem;color:#1B5E20;margin-bottom:0.4rem;">OTP Generated</div>
            <div class="otp-code-display" id="delivery-otp-display">------</div>
            <div style="font-size:0.75rem;color:#388E3C;margin-top:0.3rem;">Share verbally with Sarpanch only. Valid for this delivery.</div>
          </div>
        </div>
        <div class="card" style="margin-top:1rem;background:var(--sand);">
          <div class="card-title" style="font-size:0.95rem;">âœ… Confirm Delivery</div>
          <div class="form-group">
            <label class="form-label">Enter OTP confirmed by Sarpanch</label>
            <input class="form-control" id="confirm-otp-input" type="text" maxlength="6" placeholder="Enter 6-digit OTP" style="font-family:'IBM Plex Mono';letter-spacing:0.2em;font-size:1.2rem;">
          </div>
          <div class="form-group">
            <label class="form-label">Actual Litres Delivered</label>
            <input class="form-control" type="number" value="12000" min="1000" max="15000" step="500">
          </div>
          <div class="form-group">
            <label class="form-label">Field Remarks</label>
            <textarea class="form-control" placeholder="Any observations or notes..."></textarea>
          </div>
          <button class="btn-primary" onclick="confirmDelivery()">âœ… Confirm & Submit</button>
          <div id="confirm-msg" style="margin-top:0.8rem;"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Today's Deliveries</div>
        ${v.filter(x=>x.tankerAssigned!=='Pending').slice(0,6).map(vill=>`
          <div style="display:flex;justify-content:space-between;align-items:center;padding:0.6rem 0;border-bottom:1px solid var(--sand);font-size:0.85rem;">
            <div><div style="font-weight:600;">${vill.name}</div><div style="font-size:0.75rem;color:var(--muted);">ğŸš› ${vill.tankerAssigned} | ${vill.lastTankerLitres.toLocaleString()}L</div></div>
            <span class="badge badge-normal">âœ… Confirmed</span>
          </div>`).join('')}
      </div>
    </div>`;
  }
  else if (tab === 'escalation') {
    mc.innerHTML = header + `
    <div class="alert alert-success">âœ… <div>No open escalations at this time. All previous issues resolved.</div></div>
    <div class="card-2col">
      <div class="card">
        <div class="card-title">âš¡ Log New Escalation</div>
        <div class="form-group">
          <label class="form-label">Issue Type</label>
          <select class="form-control">
            <option>Tanker Delayed</option>
            <option>Route Blocked</option>
            <option>Water Quantity Insufficient</option>
            <option>Borewell Failed</option>
            <option>Village Access Problem</option>
            <option>Driver Issue</option>
            <option>SOS Alert Received</option>
            <option>Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Village Affected</label>
          <select class="form-control">
            ${v.slice(0,8).map(vill=>`<option>${vill.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Tanker ID</label>
          <input class="form-control" placeholder="e.g. TK-04">
        </div>
        <div class="form-group">
          <label class="form-label">Priority</label>
          <select class="form-control"><option>High</option><option>Medium</option><option>Low</option></select>
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-control" placeholder="Clearly describe what happened..."></textarea>
        </div>
        <div class="form-group"><label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.85rem;"><input type="checkbox"> ğŸ“¤ Also notify District Collector</label></div>
        <button class="btn-primary" onclick="alert('âœ… Escalation logged and notified!')">âš¡ Submit Escalation</button>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Recent Escalations</div>
        ${['Borewell failure â€” 1200 people critical','Route blocked near bridge','Tanker breakdown â€” 3hr delay','Water contamination report'].map((msg,i)=>`
          <div style="border:1px solid var(--border);border-left:4px solid ${i===0?'var(--red)':'var(--orange)'};border-radius:8px;padding:0.8rem;margin-bottom:0.7rem;">
            <div style="display:flex;justify-content:space-between;">
              <span style="font-family:'IBM Plex Mono';font-size:0.78rem;color:var(--saffron);">ESC-2026-0${i+1}${i}</span>
              <span class="badge badge-normal">âœ… Resolved</span>
            </div>
            <div style="font-weight:600;margin:0.3rem 0;">${v[i]?.name}</div>
            <div style="font-size:0.82rem;color:var(--muted);">${msg}</div>
          </div>`).join('')}
      </div>
    </div>`;
  }
  else if (tab === 'route') {
    mc.innerHTML = header + `
    <div class="alert alert-info">
      ğŸ—ºï¸ <div><strong>Greedy Route Optimizer</strong> â€” Nearest-neighbor algorithm calculates the most efficient tanker visit order. Drag to reorder stops or click "Run Optimizer" to recalculate.</div>
    </div>
    <div class="card-2col">
      <div class="card">
        <div class="card-title">âš™ï¸ Route Settings</div>
        <div class="form-group">
          <label class="form-label">Select Tanker</label>
          <select class="form-control" id="route-tanker" onchange="runRouteOptimizer()">
            <option value="TK-01">ğŸš› TK-01 (12,000L)</option>
            <option value="TK-02">ğŸš› TK-02 (12,000L)</option>
            <option value="TK-03">ğŸš› TK-03 (10,000L)</option>
            <option value="TK-04">ğŸš› TK-04 (12,000L)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Priority Filter</label>
          <select class="form-control" id="route-filter" onchange="runRouteOptimizer()">
            <option value="all">All Priority Levels</option>
            <option value="critical">Critical Only (WSI â‰¥ 80)</option>
            <option value="warning">Warning+ (WSI â‰¥ 60)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Max Stops</label>
          <select class="form-control" id="route-maxstops" onchange="runRouteOptimizer()">
            <option value="5">5 villages</option>
            <option value="8" selected>8 villages</option>
            <option value="12">12 villages</option>
          </select>
        </div>
        <button class="btn-primary" style="margin-top:0.5rem;" onclick="runRouteOptimizer()">ğŸ”„ Run Optimizer</button>
        <button class="btn-secondary" style="margin-top:0.5rem;" onclick="alert('âœ… Route dispatched to driver app!')">ğŸ“¤ Dispatch Route</button>
        <div id="route-summary" style="margin-top:1rem;padding:0.8rem;background:var(--sand);border-radius:8px;font-size:0.85rem;display:none;">
          <div style="font-weight:700;color:var(--navy);margin-bottom:0.5rem;">ğŸ“Š Route Summary</div>
          <div id="route-stats"></div>
        </div>
      </div>
      <div class="card" style="padding:0;overflow:hidden;">
        <div class="card-title" style="padding:1rem 1.2rem;">ğŸ—ºï¸ Optimized Route Map</div>
        <div id="route-map" style="height:400px;"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Optimized Stop Sequence</div>
      <div id="route-stops"></div>
    </div>`;

    setTimeout(() => runRouteOptimizer(), 100);
  }

  else if (tab === 'ground') {
    mc.innerHTML = header + `
    <div class="alert alert-info">ğŸ“¡ <div><strong>Ground Truth Entry</strong> â€” Your field observations directly feed the WSI forecasting model and improve allocation accuracy.</div></div>
    <div class="card-2col">
      <div class="card">
        <div class="card-title">ğŸ“ Submit Field Observations</div>
        <div class="form-group">
          <label class="form-label">Village</label>
          <select class="form-control">${v.slice(0,8).map(vill=>`<option>${vill.name}</option>`).join('')}</select>
        </div>
        <div class="form-group">
          <label class="form-label">Observation Date</label>
          <input class="form-control" type="date" value="2026-02-23">
        </div>
        <div style="font-size:0.85rem;font-weight:600;color:var(--muted);margin:0.8rem 0 0.3rem;">ğŸ’§ Water Source Conditions</div>
        <div class="form-group">
          <label class="form-label">Borewell Condition</label>
          <select class="form-control"><option>Good</option><option>Low</option><option>Very Low</option><option>Dry</option></select>
        </div>
        <div class="form-group">
          <label class="form-label">Canal/Nala Status</label>
          <select class="form-control"><option>Flowing</option><option>Reduced Flow</option><option>Trickle</option><option>Completely Dry</option></select>
        </div>
        <div class="form-group"><label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.85rem;color:var(--red);font-weight:600;"><input type="checkbox"> ğŸš¨ Flag as Emergency</label></div>
        <div class="form-group">
          <label class="form-label">Field Notes</label>
          <textarea class="form-control" placeholder="Additional observations..."></textarea>
        </div>
        <button class="btn-primary" onclick="alert('âœ… Ground truth submitted! WSI model will recalculate.')">ğŸ“¡ Submit Ground Truth</button>
      </div>
      <div class="card">
        <div class="card-title">â›ï¸ Borewell Status</div>
        ${v.slice(0,6).map(vill=>{
          const cond = ['Good','Low','Very Low','Dry'][Math.floor(Math.random()*4)];
          const condColor = {Good:'#2E7D32',Low:'#F9A825','Very Low':'#E65100',Dry:'#C62828'}[cond];
          const depth = (Math.random()*15+3).toFixed(1);
          return `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.6rem 0;border-bottom:1px solid var(--sand);">
            <div><div style="font-weight:600;">${vill.name}</div><div style="font-size:0.75rem;color:var(--muted);">${depth}m depth</div></div>
            <span class="badge" style="color:${condColor};border-color:${condColor};background:${condColor}22;">${cond}</span>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SARPANCH DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function loadSarpanchTab(tab) {
  setActiveNav(tab);
  const mc = document.getElementById('main-content');
  const u = appState.user;
  const sv = appState.village || appState.villages[0];
  const level = getWSILevel(sv.wsi);

  const header = `<div class="page-header">
    <div>
      <div class="page-header-title">ğŸ˜ï¸ ${sv.name} Village â€” Water Status Portal</div>
      <div class="page-header-sub">ğŸ“ ${u.district.name} District | Sarpanch: ${u.name} | ğŸŒ¾ Gram Panchayat Portal</div>
    </div>
    <div style="text-align:right;">
      <div style="font-size:0.72rem;color:rgba(255,255,255,0.6);">Water Stress Index</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:2.5rem;font-weight:700;color:${level.color}">${sv.wsi}/100</div>
      <div style="font-size:0.82rem;color:rgba(255,255,255,0.8);">${level.emoji} ${level.label}</div>
    </div>
  </div>`;

  if (tab === 'status') {
    mc.innerHTML = header + `
    <div class="alert alert-${sv.wsi>=80?'critical':sv.wsi>=60?'warning':'info'}">
      ${level.emoji} <div><strong>Drought ${level.label} Active</strong> â€” WSI: ${sv.wsi}/100 | ${sv.daysNoRain} days without rain | Est. ${sv.waterAvailDays} days of water remaining</div>
    </div>
    <div class="metrics-row">
      <div class="metric-card ${sv.wsi>=80?'critical':sv.wsi>=60?'warning':''}">
        <div class="metric-icon">ğŸ’§</div><div class="metric-val" style="color:${level.color}">${sv.wsi}/100</div><div class="metric-label">Water Stress Index</div>
      </div>
      <div class="metric-card warning"><div class="metric-icon">ğŸŒ§ï¸</div><div class="metric-val">${sv.daysNoRain}d</div><div class="metric-label">Days No Rainfall</div></div>
      <div class="metric-card critical"><div class="metric-icon">â›ï¸</div><div class="metric-val">${sv.gwDrop}m</div><div class="metric-label">Groundwater Drop/Month</div></div>
      <div class="metric-card"><div class="metric-icon">ğŸšï¸</div><div class="metric-val">${sv.borewellsOk}/${sv.borewellsTotal}</div><div class="metric-label">Borewells Functional</div></div>
    </div>
    <div class="card-2col">
      <div class="card">
        <div class="card-title">ğŸŒ¡ï¸ WSI Gauge</div>
        <div style="padding:1rem 0;">
          <div class="wsi-gauge-bar">
            <div class="wsi-gauge-needle" style="left:${sv.wsi}%;"></div>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--muted);margin-top:4px;">
            <span>0 â€” Safe</span><span>30 â€” Watch</span><span>60 â€” Warning</span><span>80 â€” Critical</span><span>100</span>
          </div>
        </div>
        <div class="wsi-big" style="color:${level.color};background:${level.bg};">
          <div class="wsi-num">${sv.wsi}</div>
          <div class="wsi-label">${level.emoji} ${level.label}</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Village Vitals</div>
        ${[
          ['ğŸŒ§ï¸','Last Rainfall',sv.lastRain,'info'],
          ['ğŸ’§','Rainfall vs Normal',`${100-sv.rainDeficit}% of normal`,'warning'],
          ['â›ï¸','Groundwater',`${sv.gwDrop}m drop/month`,'warning'],
          ['ğŸš›','Last Tanker',`${sv.lastTankerDate} â€” ${sv.lastTankerLitres.toLocaleString()}L`,'info'],
          ['â›½','Water Available',`Est. ${sv.waterAvailDays} days remaining`,'warning'],
          ['ğŸ‘¥','Population',`${sv.population.toLocaleString()} people`,'info'],
        ].map(([em,lab,val,typ])=>`
          <div class="alert alert-${typ}" style="padding:0.5rem 0.9rem;margin-bottom:0.45rem;font-size:0.85rem;">
            ${em} <strong>${lab}:</strong> ${val}
          </div>`).join('')}
      </div>
    </div>`;
  }
  else if (tab === 'request') {
    mc.innerHTML = header + `
    <div class="card-2col">
      <div class="card">
        <div class="card-title">ğŸ“ Submit Water Tanker Request</div>
        <div class="form-group">
          <label class="form-label">ğŸš¨ Urgency Level</label>
          <select class="form-control">
            <option>Critical â€” People without water NOW</option>
            <option>High â€” Will run out in 1â€“2 days</option>
            <option>Medium â€” Supplies running low</option>
            <option>Low â€” Routine replenishment</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ğŸ‘¥ Population Affected</label>
            <input class="form-control" type="number" value="${Math.min(1200,sv.population)}" min="50" max="${sv.population}">
          </div>
          <div class="form-group">
            <label class="form-label">ğŸ’§ Litres Required</label>
            <input class="form-control" type="number" value="12000" min="1000" max="50000" step="500">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ğŸ“… Preferred Date</label>
            <input class="form-control" type="date" value="2026-02-24">
          </div>
          <div class="form-group">
            <label class="form-label">â° Preferred Time</label>
            <select class="form-control">
              <option>Morning (6â€“10 AM)</option>
              <option>Midday (10 AMâ€“2 PM)</option>
              <option>Afternoon (2â€“6 PM)</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ”§ Primary Water Issue</label>
          <select class="form-control">
            <option>Borewells Dry/Low</option>
            <option>Canal/Nala Dry</option>
            <option>Pipeline Broken</option>
            <option>No Other Source Available</option>
            <option>Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ“Œ Remarks</label>
          <textarea class="form-control" placeholder="Describe the situation clearly..."></textarea>
        </div>
        <button class="btn-primary" onclick="alert('âœ… Request submitted! ID: TR-2026-${Math.floor(Math.random()*9000)+1000}\\nRouting to Field Officer for approval.')">ğŸ“¨ Submit Tanker Request</button>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“Š System Validation</div>
        <div style="font-size:0.82rem;color:var(--muted);margin-bottom:1rem;">System validates your request against live data to ensure accurate priority assessment.</div>
        ${[
          [`WSI Score`, `${sv.wsi}/100 â€” ${level.label}`, sv.wsi > 40],
          [`Days Without Rain`, `${sv.daysNoRain} days`, sv.daysNoRain > 7],
          [`Groundwater Drop`, `${sv.gwDrop}m/month`, sv.gwDrop > 1.5],
          [`Last Supply`, sv.lastTankerDate, false],
          [`Borewells OK`, `${sv.borewellsOk}/${sv.borewellsTotal}`, sv.borewellsOk < sv.borewellsTotal],
        ].map(([lab,val,flag])=>`
          <div style="display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid var(--sand);font-size:0.85rem;">
            <span style="color:var(--muted);">${flag&&sv.wsi>60?'ğŸ”´':flag?'ğŸŸ¡':'ğŸŸ¢'} ${lab}</span>
            <strong>${val}</strong>
          </div>`).join('')}
        <div style="margin-top:1rem;padding:0.8rem;background:${sv.wsi>=60?'#FFF3E0':'#E8F5E9'};border-radius:8px;font-size:0.82rem;font-weight:600;color:${sv.wsi>=60?'var(--orange)':'var(--green)'};">
          ${sv.wsi>=60?'âš¡ HIGH PRIORITY â€” Request will be fast-tracked':'âœ… STANDARD PRIORITY â€” Normal processing'}
        </div>
      </div>
    </div>`;
  }
  else if (tab === 'tracker') {
    const tankerETA = `${Math.floor(Math.random()*4)+8}:${Math.random()>0.5?'30':'00'} AM`;
    mc.innerHTML = header + `
    <div class="card">
      <div class="card-title">ğŸš› Assigned Tanker Status</div>
      <div class="fleet-card status-transit">
        <div>
          <div style="font-size:1.1rem;font-weight:700;">${sv.tankerAssigned !== 'Pending' ? `ğŸš› Tanker ${sv.tankerAssigned}` : 'â³ No Tanker Currently Assigned'}</div>
          <div style="font-size:0.82rem;color:var(--muted);margin-top:0.3rem;">Capacity: 12,000 L | From: ${u.district.name} Depot | Driver: Raju Kumar ğŸ“ 98XXXXXXX</div>
        </div>
        <div style="text-align:right;">
          <span class="badge badge-watch">ğŸš› In Transit</span>
          <div style="font-family:'Rajdhani',sans-serif;font-size:1.3rem;font-weight:700;color:var(--saffron);margin-top:0.4rem;">ETA: ${tankerETA}</div>
        </div>
      </div>
      <div style="margin-top:0.8rem;">
        <div style="display:flex;justify-content:space-between;font-size:0.78rem;color:var(--muted);margin-bottom:4px;">
          <span>ğŸ­ Departed depot 8:00 AM</span><span>65% of route</span><span>ğŸ˜ï¸ ETA ${tankerETA}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:65%;background:linear-gradient(90deg,var(--saffron),#E85D00);"></div>
        </div>
        <div style="font-size:0.77rem;color:var(--muted);margin-top:4px;">ğŸ›£ï¸ 26 km covered of 40 km total</div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ—ºï¸ Delivery Timeline</div>
      ${[
        ['08:00 AM','Tanker TK-04 departed depot',true],
        ['08:45 AM','Passed checkpoint â€” on route',true],
        ['09:30 AM','Currently en route â€” ETA updated',true],
        [tankerETA,'Expected arrival at village collection point',false],
        [tankerETA.replace(/\d+:/,(h)=>`${parseInt(h)+1}:`),'Distribution to households begins',false],
      ].map(([time,ev,done])=>`
        <div class="timeline-item">
          <div class="timeline-dot" style="color:${done?'var(--green)':'var(--border)'};background:${done?'var(--green)':'var(--sand)'};"></div>
          <div>
            <div style="font-size:0.78rem;font-weight:600;color:var(--saffron);">${time}</div>
            <div style="font-size:0.87rem;color:${done?'var(--text)':'var(--muted)'};">${ev}</div>
          </div>
        </div>`).join('')}
    </div>`;
  }
  else if (tab === 'history') {
    const history = Array.from({length:7},(_,i)=>{
      const d = 23 - i*4;
      return {date:`Feb ${Math.max(1,d)}, 2026`, tanker:`TK-0${(i%5)+1}`, litres:(Math.floor(Math.random()*4)+6)*1000, status: i===5?'Partial':'Delivered'};
    });
    const totalL = history.reduce((a,b)=>a+b.litres,0);
    mc.innerHTML = header + `
    <div class="metrics-row">
      <div class="metric-card"><div class="metric-icon">ğŸ“¦</div><div class="metric-val">${history.length}</div><div class="metric-label">Total Deliveries</div></div>
      <div class="metric-card"><div class="metric-icon">ğŸ’§</div><div class="metric-val">${(totalL/1000).toFixed(0)}kL</div><div class="metric-label">Total Litres</div></div>
      <div class="metric-card"><div class="metric-icon">ğŸ“Š</div><div class="metric-val">${Math.round(totalL/history.length/1000)}kL</div><div class="metric-label">Avg Per Delivery</div></div>
      <div class="metric-card"><div class="metric-icon">ğŸ“…</div><div class="metric-val">4.2d</div><div class="metric-label">Avg Frequency</div></div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Delivery Log</div>
      <table class="village-table">
        <thead><tr><th>Date</th><th>Tanker ID</th><th>Litres</th><th>Status</th><th>Households Served</th></tr></thead>
        <tbody>
          ${history.map(d=>{
            const sc = d.status==='Delivered'?'badge-normal':'badge-watch';
            return `<tr>
              <td>${d.date}</td>
              <td style="font-family:'IBM Plex Mono';color:var(--saffron);">${d.tanker}</td>
              <td style="font-weight:600;">${d.litres.toLocaleString()} L</td>
              <td><span class="badge ${sc}">${d.status==='Delivered'?'âœ…':'ğŸŸ¡'} ${d.status}</span></td>
              <td>${Math.floor(d.litres/50)} HH</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`;
  }
  else if (tab === 'board') {
    mc.innerHTML = header + `
    <div class="card-2col">
      <div class="card">
        <div class="card-title">ğŸ“£ Community Notification Board</div>
        ${[
          {icon:'ğŸš›',time:'Today 9:15 AM',msg:`Tanker ${sv.tankerAssigned!=='Pending'?sv.tankerAssigned:'TK-04'} dispatched. Expected arrival by late morning.`,type:'info'},
          {icon:'ğŸŒ¡ï¸',time:'Today 8:00 AM',msg:`Drought ${level.label} active. WSI: ${sv.wsi}/100. Please conserve water.`,type:'warning'},
          {icon:'âœ…',time:sv.lastTankerDate,msg:`Tanker delivery confirmed. ${sv.lastTankerLitres.toLocaleString()} L supplied to ${Math.floor(sv.lastTankerLitres/50)} households.`,type:'success'},
          {icon:'ğŸ“‹',time:'Feb 19, 11 AM',msg:'Tanker request approved by Field Officer.',type:'success'},
          {icon:'ğŸŒ§ï¸',time:sv.lastRain,msg:`Last rainfall recorded. ${sv.daysNoRain} days ago. Next rainfall: Low probability.`,type:'info'},
          {icon:'âš ï¸',time:'Feb 04, 9 AM',msg:`Groundwater dropped ${sv.gwDrop}m in 30 days. Monitor usage carefully.`,type:'warning'},
        ].map(n=>{
          const bc = {info:'var(--saffron)',warning:'var(--orange)',success:'var(--green)'}[n.type];
          return `<div class="notif-item" style="border-left:3px solid ${bc};">
            <div style="font-size:1.4rem;">${n.icon}</div>
            <div><div style="font-size:0.85rem;">${n.msg}</div><div style="font-size:0.75rem;color:var(--muted);margin-top:3px;">ğŸ• ${n.time}</div></div>
          </div>`;
        }).join('')}
      </div>
      <div>
        <div class="card" style="border:2px solid var(--red);">
          <div class="card-title" style="color:var(--red);">ğŸ†˜ Emergency SOS Alert</div>
          <div style="font-size:0.85rem;color:var(--muted);margin-bottom:1rem;">Use ONLY in water emergencies. Instantly alerts the Field Officer AND District Collector.</div>
          <div class="form-group">
            <label class="form-label">Emergency Type</label>
            <select class="form-control">
              <option>Select type...</option>
              <option>Borewell failure â€” village without water</option>
              <option>Tanker not arrived â€” 48+ hours overdue</option>
              <option>Water source contaminated / toxic</option>
              <option>Mass illness linked to water quality</option>
              <option>Other critical emergency</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">People Directly Affected</label>
            <input class="form-control" type="number" value="500" min="1" max="${sv.population}">
          </div>
          <div class="form-group">
            <label class="form-label">Brief Description</label>
            <textarea class="form-control" placeholder="Describe the emergency clearly..."></textarea>
          </div>
          <button class="btn-primary" style="background:linear-gradient(135deg,var(--red),#8B0000);box-shadow:0 4px 15px rgba(198,40,40,0.4);" onclick="alert('ğŸ†˜ SOS SENT!\\nSOS ID: SOS-2026-' + Math.floor(Math.random()*999)+'\\nNotified: Field Officer + District Collector\\nExpected Response: 2â€“4 hours')">ğŸ†˜ SEND SOS ALERT â€” ESCALATE NOW</button>
        </div>
      </div>
    </div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initMap(containerId, lat, lng, villages, showColors) {
  setTimeout(() => {
    if (appState.mapInstance) {
      appState.mapInstance.remove();
      appState.mapInstance = null;
    }
    const map = L.map(containerId).setView([lat, lng], 10);
    appState.mapInstance = map;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 18
    }).addTo(map);

    villages.forEach(vill => {
      const level = getWSILevel(vill.wsi);
      const radius = showColors ? 8 + (vill.wsi / 10) : 8;
      const color = showColors ? level.color : '#FF6B00';

      const circle = L.circleMarker([vill.lat, vill.lng], {
        radius,
        color: color,
        fillColor: color,
        fillOpacity: 0.7,
        weight: 2,
      }).addTo(map);

      circle.bindPopup(`
        <div style="font-family:'Noto Sans',sans-serif;min-width:200px;">
          <div style="font-weight:700;font-size:1rem;color:#0D2137;border-bottom:2px solid #FF6B00;padding-bottom:4px;margin-bottom:8px;">${vill.name}</div>
          <div style="font-size:0.85rem;line-height:1.8;">
            <div>ğŸ’§ <strong>WSI:</strong> <span style="color:${level.color};font-weight:700;">${vill.wsi} â€” ${level.label}</span></div>
            <div>ğŸ‘¥ <strong>Population:</strong> ${vill.population.toLocaleString()}</div>
            <div>ğŸŒ§ï¸ <strong>Days No Rain:</strong> ${vill.daysNoRain}d</div>
            <div>â›ï¸ <strong>Groundwater Drop:</strong> ${vill.gwDrop}m/mo</div>
            <div>ğŸš› <strong>Tanker:</strong> ${vill.tankerAssigned}</div>
            <div>ğŸšï¸ <strong>Borewells OK:</strong> ${vill.borewellsOk}/${vill.borewellsTotal}</div>
          </div>
        </div>
      `);
    });
  }, 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function drawWSIChart(v) {
  setTimeout(() => {
    const ctx = document.getElementById('wsiChart');
    if (!ctx) return;
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: v.slice(0,10).map(x=>x.name),
        datasets: [{
          label: 'WSI Score',
          data: v.slice(0,10).map(x=>x.wsi),
          backgroundColor: v.slice(0,10).map(x=>getWSILevel(x.wsi).color+'88'),
          borderColor: v.slice(0,10).map(x=>getWSILevel(x.wsi).color),
          borderWidth: 2,
          borderRadius: 4,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, max: 100, grid: { color: '#F5ECD7' } },
          x: { grid: { display: false } }
        }
      }
    });
  }, 200);
}

function drawRainChart() {
  setTimeout(() => {
    const ctx = document.getElementById('rainChart');
    if (!ctx) return;
    const months = ['Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec','Jan','Feb'];
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          {label:'Normal (mm)',data:[12,8,22,180,280,350,280,150,60,20,8,12],borderColor:'#aaa',borderDash:[5,5],borderWidth:2,fill:false,pointRadius:3},
          {label:'Actual (mm)',data:[10,6,18,160,240,310,200,80,20,5,1,4],borderColor:'#FF6B00',borderWidth:2.5,fill:true,backgroundColor:'rgba(255,107,0,0.1)',pointRadius:4,tension:0.3},
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position:'top' } },
        scales: { y: { beginAtZero: true, grid: { color: '#F5ECD7' } }, x: { grid: { display: false } } }
      }
    });
  }, 200);
}

function drawForecastChart() {
  setTimeout(() => {
    const ctx = document.getElementById('forecastChart');
    if (!ctx) return;
    const days = ['Feb 24','Feb 25','Feb 26','Feb 27','Feb 28','Mar 1','Mar 2'];
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: days,
        datasets: [
          {label:'Demand (Tankers)',data:[12,14,16,15,18,20,17],backgroundColor:'rgba(255,107,0,0.7)',borderColor:'#FF6B00',borderWidth:2,borderRadius:4},
          {label:'Available Fleet',data:[10,10,11,10,10,9,11],backgroundColor:'rgba(13,33,55,0.6)',borderColor:'#0D2137',borderWidth:2,borderRadius:4},
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position:'top' } },
        scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }
      }
    });
  }, 200);
}

function drawBudgetChart() {
  setTimeout(() => {
    const ctx = document.getElementById('budgetChart');
    if (!ctx) return;
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Tanker Hire','Fuel','Driver Allowance','Maintenance','Admin'],
        datasets: [{
          data: [45,30,12,8,5],
          backgroundColor: ['#FF6B00','#0D2137','#D4AC0D','#138808','#aaa'],
          borderWidth: 2,
          borderColor: '#FEF9F0',
        }]
      },
      options: { responsive: true, plugins: { legend: { position:'bottom' } } }
    });
  }, 200);
}

function drawGWChart() {
  setTimeout(() => {
    const ctx = document.getElementById('gwChart');
    if (!ctx) return;
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Sep','Oct','Nov','Dec','Jan','Feb'],
        datasets: appState.villages.slice(0,4).map((v,i)=>({
          label: v.name,
          data: [3,3.5,5,6,7.5+i,8+v.gwDrop].map(x=>+(x+Math.random()*0.5).toFixed(1)),
          borderColor: ['#FF6B00','#C62828','#F9A825','#0277BD'][i],
          borderWidth: 2,
          fill: false,
          tension: 0.3,
          pointRadius: 3,
        }))
      },
      options: {
        responsive: true,
        plugins: { legend: { position:'top' } },
        scales: {
          y: { title: { display:true, text:'Depth (m below surface)' }, grid: { color: '#F5ECD7' } },
          x: { grid: { display: false } }
        }
      }
    });
  }, 200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPER GENERATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function generateFleetOverview() {
  return `<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.8rem;">
    ${[
      {label:'In Transit',count:3,color:'var(--saffron)',icon:'ğŸš›'},
      {label:'Available',count:2,color:'var(--green)',icon:'âœ…'},
      {label:'Delivered Today',count:5,color:'var(--blue)',icon:'ğŸ“¦'},
      {label:'Maintenance',count:1,color:'var(--red)',icon:'ğŸ”§'},
    ].map(f=>`
      <div style="background:var(--sand);border-radius:8px;padding:0.8rem;text-align:center;">
        <div style="font-size:1.5rem;">${f.icon}</div>
        <div style="font-size:1.8rem;font-weight:700;font-family:'Rajdhani',sans-serif;color:${f.color};">${f.count}</div>
        <div style="font-size:0.72rem;color:var(--muted);font-weight:600;">${f.label}</div>
      </div>`).join('')}
  </div>`;
}

function generateFleetCards(detailed = false) {
  const statuses = ['In Transit','Delivered','Available','In Transit','Scheduled','Under Maintenance','In Transit'];
  const statusColors = {'In Transit':'var(--saffron)','Delivered':'var(--green)','Available':'var(--blue)','Scheduled':'var(--muted)','Under Maintenance':'var(--red)'};
  const statusClass = {'In Transit':'status-transit','Delivered':'status-delivered','Available':'status-available','Scheduled':'status-scheduled','Under Maintenance':'status-maintenance'};
  const v = appState.villages;

  return statuses.slice(0,5).map((status,i)=>{
    const km = status==='In Transit' ? Math.floor(Math.random()*30)+10 : 0;
    const fuel = status==='Under Maintenance' ? 0 : Math.floor(Math.random()*60)+30;
    const fuelColor = fuel<30?'var(--red)':fuel<60?'var(--yellow)':'var(--green)';
    return `<div class="fleet-card ${statusClass[status]}">
      <div>
        <div style="font-weight:700;">ğŸš› TK-${String(i+1).padStart(2,'0')} <span class="badge" style="color:${statusColors[status]};border-color:${statusColors[status]};background:${statusColors[status]}22;margin-left:0.5rem;">${status}</span></div>
        <div style="font-size:0.8rem;color:var(--muted);margin-top:3px;">12,000L | ${v[i]?.name || 'Unassigned'}</div>
        ${status==='In Transit'?`<div class="progress-bar" style="margin-top:0.5rem;width:120px;"><div class="progress-fill" style="width:${Math.floor(Math.random()*60)+30}%;background:var(--saffron);"></div></div>
        <div style="font-size:0.72rem;color:var(--muted);margin-top:2px;">${km} km remaining</div>`:''}
      </div>
      <div style="text-align:right;">
        ${fuel>0?`<div style="font-size:0.72rem;color:var(--muted);">Fuel: ${fuel}%</div>
        <div class="progress-bar" style="width:60px;margin-top:2px;"><div class="progress-fill" style="width:${fuel}%;background:${fuelColor};"></div></div>`
        :'<div style="color:var(--red);font-size:0.78rem;font-weight:600;">ğŸ”§ In Workshop</div>'}
      </div>
    </div>`;
  }).join('');
}

function generatePolicyAlerts(v, expanded = false) {
  const critical = v.filter(x=>x.wsi>=80);
  const alerts = [
    critical.length > 0 ? `ğŸ”´ <strong>${critical.length} village(s) entering Critical status</strong> â€” ${critical.map(x=>x.name).slice(0,3).join(', ')} WSI > 80. Immediate intervention required.` : null,
    `ğŸŸ  Groundwater falling ${(Math.random()*10+5).toFixed(0)}% faster than same period last year across ${Math.floor(Math.random()*5)+3} villages.`,
    `ğŸš› Fleet shortage predicted in ${Math.floor(Math.random()*7)+5} days based on demand forecast. Request ${Math.floor(Math.random()*3)+2} additional tankers.`,
    `ğŸ“ˆ ${v.filter(x=>x.wsi>=60).length} villages transitioning from Watch to Warning zone over next week.`,
    `ğŸ’§ District average WSI of ${Math.round(v.reduce((a,b)=>a+b.wsi,0)/v.length)} is ${Math.floor(Math.random()*15+5)}% above last year's average.`,
  ].filter(Boolean);

  return alerts.slice(0, expanded ? 5 : 3).map(msg=>`
    <div class="policy-alert">
      <div class="alert-title">POLICY ALERT</div>
      <div>${msg}</div>
    </div>`).join('');
}

function generateTankerForecast() {
  return `<div style="font-size:0.85rem;color:var(--muted);margin-bottom:0.8rem;">Based on current WSI trends and historical patterns</div>
  ${['Today','Tomorrow','Feb 25','Feb 26','Feb 27','Feb 28','Mar 1'].map((day,i)=>{
    const demand = Math.floor(Math.random()*8)+10;
    const avail = Math.floor(Math.random()*4)+8;
    const deficit = Math.max(0, demand - avail);
    return `<div style="display:flex;align-items:center;gap:0.8rem;padding:0.4rem 0;border-bottom:1px solid var(--sand);font-size:0.83rem;">
      <div style="width:60px;font-weight:600;color:var(--navy);">${day}</div>
      <div style="flex:1;">
        <div class="progress-bar"><div class="progress-fill" style="width:${demand*5}%;background:${deficit>0?'var(--red)':'var(--green)'};"></div></div>
      </div>
      <div style="font-family:'IBM Plex Mono';font-size:0.8rem;">
        <span style="color:var(--navy);">${demand}</span>/<span style="color:var(--green);">${avail}</span>
        ${deficit>0?`<span style="color:var(--red);"> -${deficit}</span>`:''}
      </div>
    </div>`;
  }).join('')}
  <div style="font-size:0.72rem;color:var(--muted);margin-top:0.6rem;">Demand / Available | Red = shortage predicted</div>`;
}

function generateRouteOpt(v) {
  return v.slice(0,5).map((vill,i)=>{
    const km = Math.floor(Math.random()*40)+10;
    const hrs = (km/40 + Math.random()*0.5).toFixed(1);
    const level = getWSILevel(vill.wsi);
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem 0;border-bottom:1px solid var(--sand);font-size:0.83rem;">
      <div>
        <div style="font-weight:600;">${i+1}. ${vill.name}</div>
        <div style="font-size:0.75rem;color:var(--muted);">ğŸ›£ï¸ ${km} km | â±ï¸ ${hrs}h ETA | TK-0${i+1}</div>
      </div>
      <span class="badge ${level.cls}">${level.emoji} ${level.label}</span>
    </div>`;
  }).join('') +
  `<button class="btn-primary" style="margin-top:0.8rem;padding:0.6rem;" onclick="alert('âœ… All routes approved and dispatched!')">âœ… Approve All Routes</button>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OTP HELPER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIGITAL TWIN SIMULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateTwin() {
  const rain = parseInt(document.getElementById('sim-rain')?.value || 0);
  const days = parseInt(document.getElementById('sim-days')?.value || 7);
  const temp = parseFloat(document.getElementById('sim-temp')?.value || 0);
  const lpd = parseInt(document.getElementById('sim-lpd')?.value || 50);

  // Update labels
  const lRain = document.getElementById('lbl-rain');
  const lDays = document.getElementById('lbl-days');
  const lTemp = document.getElementById('lbl-temp');
  const lLpd = document.getElementById('lbl-lpd');
  if (lRain) lRain.textContent = rain + '%';
  if (lDays) lDays.textContent = days;
  if (lTemp) lTemp.textContent = '+' + temp + 'Â°C';
  if (lLpd) lLpd.textContent = lpd + 'L';

  const baseVillages = appState.villages;
  const simVillages = baseVillages.map((v, i) => {
    const rainMod = rain * 0.30;
    const tempMod = temp * 4;
    const daysMod = (days / 30) * 10;
    const simWSI = Math.min(100, Math.round(
      (window._twinBaseWSI[i] || v.wsi) + rainMod * 0.5 + tempMod * 0.3 + daysMod * 0.2
    ));
    return { ...v, wsi: simWSI };
  });

  const critical = simVillages.filter(v => v.wsi >= 80).length;
  const avgWSI = Math.round(simVillages.reduce((a, b) => a + b.wsi, 0) / simVillages.length);

  // Demand formula from feature sheet: population Ã— lpd Ã— days Ã— wsi_multiplier Ã— seasonal_factor
  const month = new Date().getMonth();
  const seasonal = (month >= 3 && month <= 5) ? 1.5 : (month >= 6 && month <= 8) ? 0.3 : 1.0;
  let totalTankers = 0;
  simVillages.forEach(v => {
    const wsiMult = v.wsi >= 80 ? 2.0 : v.wsi >= 60 ? 1.0 : v.wsi >= 30 ? 0.5 : 0.0;
    const demandL = v.population * lpd * days * wsiMult * seasonal;
    totalTankers += Math.ceil(demandL / 12000);
  });

  const costLakh = (totalTankers * 4.5 / 100).toFixed(1); // â‚¹4500/trip

  // Update metric cards
  const elCrit = document.getElementById('twin-critical');
  const elTank = document.getElementById('twin-tankers');
  const elAvg = document.getElementById('twin-avgwsi');
  const elCost = document.getElementById('twin-cost');
  if (elCrit) elCrit.textContent = critical;
  if (elTank) elTank.textContent = totalTankers;
  if (elAvg) elAvg.textContent = avgWSI;
  if (elCost) elCost.textContent = 'â‚¹' + costLakh + 'L';

  // Update map
  const mapEl = document.getElementById('twin-map');
  if (mapEl) {
    if (window._twinMap) { window._twinMap.remove(); window._twinMap = null; }
    const u = appState.user;
    const map = L.map('twin-map').setView([u.district.lat, u.district.lng], 10);
    window._twinMap = map;
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);
    simVillages.forEach(v => {
      const level = getWSILevel(v.wsi);
      L.circleMarker([v.lat, v.lng], {
        radius: 8 + (v.wsi / 10),
        color: level.color,
        fillColor: level.color,
        fillOpacity: 0.75,
        weight: 2,
      }).addTo(map).bindPopup(
        `<strong>${v.name}</strong><br>Simulated WSI: <span style="color:${level.color};font-weight:700;">${v.wsi}</span><br>
        Baseline: ${window._twinBaseWSI[simVillages.indexOf(v)] || v.wsi} â†’ <strong>${v.wsi}</strong>`
      );
    });
  }

  // Update bar chart
  const ctx = document.getElementById('twinChart');
  if (ctx) {
    if (window._twinChart) { window._twinChart.destroy(); window._twinChart = null; }
    window._twinChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: simVillages.slice(0, 12).map(v => v.name),
        datasets: [
          {
            label: 'Baseline WSI',
            data: (window._twinBaseWSI || simVillages.map(v => v.wsi)).slice(0, 12),
            backgroundColor: 'rgba(13,33,55,0.4)',
            borderColor: '#0D2137',
            borderWidth: 2,
            borderRadius: 3,
          },
          {
            label: 'Simulated WSI',
            data: simVillages.slice(0, 12).map(v => v.wsi),
            backgroundColor: simVillages.slice(0, 12).map(v => getWSILevel(v.wsi).color + '99'),
            borderColor: simVillages.slice(0, 12).map(v => getWSILevel(v.wsi).color),
            borderWidth: 2,
            borderRadius: 3,
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: {
          y: { beginAtZero: true, max: 100, grid: { color: '#F5ECD7' } },
          x: { grid: { display: false } }
        }
      }
    });
  }

  // Update table
  const tableEl = document.getElementById('twin-table');
  if (tableEl) {
    tableEl.innerHTML = `<table class="village-table">
      <thead><tr><th>Village</th><th>Baseline WSI</th><th>Simulated WSI</th><th>Change</th><th>Status</th><th>Tankers Needed</th></tr></thead>
      <tbody>
      ${simVillages.map((v, i) => {
        const base = window._twinBaseWSI[i] || v.wsi;
        const delta = v.wsi - base;
        const level = getWSILevel(v.wsi);
        const wsiMult = v.wsi >= 80 ? 2.0 : v.wsi >= 60 ? 1.0 : v.wsi >= 30 ? 0.5 : 0.0;
        const demandL = v.population * lpd * days * wsiMult * seasonal;
        const tanks = Math.ceil(demandL / 12000);
        return `<tr>
          <td><strong>${v.name}</strong></td>
          <td style="font-family:'IBM Plex Mono';color:var(--muted);">${base}</td>
          <td style="font-family:'IBM Plex Mono';font-weight:700;color:${level.color};">${v.wsi}</td>
          <td style="color:${delta > 0 ? '#C62828' : '#2E7D32'};font-weight:600;">${delta > 0 ? '+' : ''}${delta}</td>
          <td><span class="badge ${level.cls}">${level.emoji} ${level.label}</span></td>
          <td style="font-family:'IBM Plex Mono';">${tanks > 0 ? tanks + ' tankers' : 'â€”'}</td>
        </tr>`;
      }).join('')}
      </tbody>
    </table>`;
  }
}

function resetTwin() {
  const sliders = ['sim-rain','sim-days','sim-temp','sim-lpd'];
  const defaults = [0, 7, 0, 50];
  sliders.forEach((id, i) => {
    const el = document.getElementById(id);
    if (el) el.value = defaults[i];
  });
  updateTwin();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUTE OPTIMIZER (Greedy Nearest Neighbor TSP)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function haversine(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function greedyRoute(depot, villages) {
  const remaining = [...villages];
  const route = [depot];
  let current = depot;
  while (remaining.length > 0) {
    let nearest = null, minDist = Infinity, idx = -1;
    remaining.forEach((v, i) => {
      const d = haversine(current.lat, current.lng, v.lat, v.lng);
      if (d < minDist) { minDist = d; nearest = v; idx = i; }
    });
    route.push({ ...nearest, distFromPrev: minDist });
    current = nearest;
    remaining.splice(idx, 1);
  }
  return route;
}

function runRouteOptimizer() {
  const filterEl = document.getElementById('route-filter');
  const maxEl = document.getElementById('route-maxstops');
  const tankerEl = document.getElementById('route-tanker');
  if (!filterEl) return;

  const filter = filterEl.value;
  const maxStops = parseInt(maxEl.value);
  const tanker = tankerEl.value;

  let pool = [...appState.villages];
  if (filter === 'critical') pool = pool.filter(v => v.wsi >= 80);
  else if (filter === 'warning') pool = pool.filter(v => v.wsi >= 60);

  const depot = { name: 'Depot', lat: appState.user.district.lat, lng: appState.user.district.lng };
  const selected = pool.slice(0, maxStops);
  const route = greedyRoute(depot, selected);

  // Total distance
  let totalKm = 0;
  for (let i = 1; i < route.length; i++) totalKm += route[i].distFromPrev || 0;
  const backKm = haversine(route[route.length-1].lat, route[route.length-1].lng, depot.lat, depot.lng);
  totalKm += backKm;
  const hrs = (totalKm / 40).toFixed(1);

  // Summary
  const summaryEl = document.getElementById('route-summary');
  const statsEl = document.getElementById('route-stats');
  if (summaryEl) summaryEl.style.display = 'block';
  if (statsEl) statsEl.innerHTML = `
    <div style="display:flex;gap:1.5rem;flex-wrap:wrap;">
      <div><span style="color:var(--muted);">Tanker:</span> <strong>${tanker}</strong></div>
      <div><span style="color:var(--muted);">Stops:</span> <strong>${selected.length}</strong></div>
      <div><span style="color:var(--muted);">Total Distance:</span> <strong>${totalKm.toFixed(1)} km</strong></div>
      <div><span style="color:var(--muted);">Est. Time:</span> <strong>${hrs} hours</strong></div>
      <div><span style="color:var(--muted);">Avg Speed:</span> <strong>40 km/h</strong></div>
    </div>`;

  // Map
  const mapEl = document.getElementById('route-map');
  if (mapEl) {
    if (window._routeMap) { window._routeMap.remove(); window._routeMap = null; }
    const u = appState.user;
    const map = L.map('route-map').setView([u.district.lat, u.district.lng], 10);
    window._routeMap = map;
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // Depot marker
    L.marker([depot.lat, depot.lng], {
      icon: L.divIcon({
        className: '',
        html: '<div style="background:#0D2137;color:white;padding:4px 8px;border-radius:20px;font-size:0.72rem;font-weight:700;white-space:nowrap;border:2px solid #FF6B00;">ğŸ­ DEPOT</div>',
        iconAnchor: [30, 15]
      })
    }).addTo(map);

    // Village markers with stop numbers
    route.slice(1).forEach((v, i) => {
      const level = getWSILevel(v.wsi);
      L.marker([v.lat, v.lng], {
        icon: L.divIcon({
          className: '',
          html: `<div style="background:${level.color};color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.85rem;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);">${i+1}</div>`,
          iconAnchor: [14, 14]
        })
      }).addTo(map).bindPopup(
        `<strong>Stop ${i+1}: ${v.name}</strong><br>WSI: <span style="color:${level.color};font-weight:700;">${v.wsi}</span><br>
        Distance: ${(v.distFromPrev||0).toFixed(1)} km from prev<br>
        Population: ${v.population?.toLocaleString()}`
      );
    });

    // Draw polyline: depot â†’ stops â†’ depot
    const latlngs = [
      [depot.lat, depot.lng],
      ...route.slice(1).map(v => [v.lat, v.lng]),
      [depot.lat, depot.lng]
    ];
    L.polyline(latlngs, {
      color: '#FF6B00',
      weight: 3,
      opacity: 0.8,
      dashArray: null
    }).addTo(map);

    // Fit bounds
    const bounds = L.latLngBounds(latlngs);
    map.fitBounds(bounds, { padding: [30, 30] });
  }

  // Stop sequence table
  const stopsEl = document.getElementById('route-stops');
  if (stopsEl) {
    let cumKm = 0;
    stopsEl.innerHTML = `<table class="village-table">
      <thead><tr><th>Stop</th><th>Village</th><th>WSI</th><th>Priority</th><th>Distance from Prev</th><th>Cumulative km</th><th>Est. Arrival</th><th>Population</th></tr></thead>
      <tbody>
        <tr style="background:var(--sand);">
          <td><strong>ğŸ­ Start</strong></td><td colspan="7"><strong>Depot â€” ${appState.user.district.name}</strong> | Departure: 07:00 AM</td>
        </tr>
        ${route.slice(1).map((v, i) => {
          cumKm += v.distFromPrev || 0;
          const mins = Math.round(cumKm / 40 * 60) + 420; // 7:00 AM = 420 mins
          const arrH = String(Math.floor(mins/60)).padStart(2,'0');
          const arrM = String(mins%60).padStart(2,'0');
          const level = getWSILevel(v.wsi);
          return `<tr>
            <td><strong style="color:var(--saffron);">#${i+1}</strong></td>
            <td><strong>${v.name}</strong></td>
            <td style="font-family:'IBM Plex Mono';color:${level.color};font-weight:700;">${v.wsi}</td>
            <td><span class="badge ${level.cls}">${level.emoji} ${level.label}</span></td>
            <td>${(v.distFromPrev||0).toFixed(1)} km</td>
            <td style="font-family:'IBM Plex Mono';">${cumKm.toFixed(1)} km</td>
            <td style="font-family:'IBM Plex Mono';color:var(--navy);">${arrH}:${arrM}</td>
            <td>${v.population?.toLocaleString()}</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>`;
  }
}

let currentDeliveryOTP = null;

function generateDeliveryOTP() {
  currentDeliveryOTP = String(Math.floor(100000 + Math.random() * 900000));
  document.getElementById('delivery-otp-display').textContent = currentDeliveryOTP;
  document.getElementById('generated-otp-box').style.display = 'block';
}

function confirmDelivery() {
  const entered = document.getElementById('confirm-otp-input').value;
  const msgEl = document.getElementById('confirm-msg');
  if (!currentDeliveryOTP) {
    msgEl.innerHTML = '<div class="alert alert-warning">âš ï¸ Please generate an OTP first.</div>';
  } else if (entered === currentDeliveryOTP) {
    msgEl.innerHTML = '<div class="alert alert-success">âœ… OTP Verified! Delivery confirmed and logged successfully.</div>';
    currentDeliveryOTP = null;
  } else {
    msgEl.innerHTML = '<div class="alert alert-critical">âŒ OTP Mismatch. Please verify with Sarpanch and re-enter.</div>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION TIMER & CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

setInterval(() => {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});
  const el = document.getElementById('current-time');
  if (el) el.textContent = `ğŸ“… ${now.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'})} | ğŸ• ${timeStr}`;

  const sessionEl = document.getElementById('session-time');
  if (sessionEl && appState.sessionStart) {
    const elapsed = Math.floor((Date.now() - appState.sessionStart) / 1000);
    const mins = Math.floor(elapsed / 60);
    const secs = elapsed % 60;
    sessionEl.textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
  }
}, 1000);
</script>
</body>
</html>
